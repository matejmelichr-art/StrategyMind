<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StrategyMind ‚Äî Market Scanner</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

  <style>
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .row:hover{background:#f8fafc}
    .pill{padding:.375rem .625rem;border-radius:9999px;border:1px solid rgba(15,23,42,.08)}
    .kbd{background:#f3f4f6;padding:.125rem .375rem;border-radius:.25rem;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;font-size:.75rem}

    /* tabulka ‚Äì sloupce */
    .table-grid{
      display:grid; grid-template-columns: 90px 1fr 120px 100px 100px 250px 80px 220px; align-items:center;
    }
    .cell-nowrap{white-space:nowrap}
    .actions{display:flex;justify-content:flex-end;gap:.5rem}
    @media (max-width: 1180px){ .table-grid{grid-template-columns: 80px 1fr 110px 95px 95px 240px 70px 200px} }

    /* badge/insights */
    .badge{display:inline-flex;align-items:center;gap:.35rem;border:1px solid rgba(15,23,42,.12);border-radius:9999px;padding:.25rem .55rem;font-size:.75rem}
    .impact-up{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .impact-down{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}
    .impact-flat{background:#f1f5f9;border-color:#cbd5e1;color:#334155}
    .tag{display:inline-block;padding:.15rem .5rem;border:1px solid #e2e8f0;border-radius:9999px;font-size:.7rem;color:#475569;background:#fff}
    .ins-card{border:1px solid #e2e8f0;border-radius:1rem;background:white}

    /* modal / buttons */
    .overlay{background:rgba(2,6,23,.45)}
    .fade-enter{opacity:0;transform:translateY(6px)} .fade-enter-active{opacity:1;transform:none;transition:all .18s ease}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.75rem;padding:.5rem .9rem}
    .btn-primary{background:#06b6d4;color:#fff} .btn-primary:hover{background:#0891b2}
    .btn-ghost{border:1px solid #e2e8f0;background:#fff} .btn-ghost:hover{background:#f8fafc}

    /* hvƒõzda */
    .star{width:18px;height:18px;color:#94a3b8} .star.active{color:#f59e0b}

    /* --- detail ≈ô√°dku --- */
    .row-head{cursor:pointer}
    .chev{transition:transform .18s ease}
    .row.open .chev{transform:rotate(180deg)}
    .details{display:none}
    .row.open + .details{display:block}

    /* mini-graf (SVG) */
    .spark path.avg{stroke:#2563eb;stroke-width:2;fill:none}
    .spark path.min,.spark path.max{stroke-width:2;fill:none;stroke-dasharray:4 4}
    .spark path.min{stroke:#ef4444}.spark path.max{stroke:#22c55e}
    .spark line.guide{stroke:#94a3b8;stroke-dasharray:4 4;opacity:.6}
    .spark .now{stroke:#0ea5e9;stroke-width:2}
    .target-badges{display:flex;gap:.5rem;flex-wrap:wrap}
    .tg{display:inline-flex;align-items:center;gap:.4rem;border:1px solid #e2e8f0;border-radius:9999px;padding:.2rem .5rem;font-size:.75rem;background:#fff}
    .tg .dot{width:.5rem;height:.5rem;border-radius:9999px}
    .dot.min{background:#ef4444}.dot.avg{background:#2563eb}.dot.max{background:#22c55e}.dot.now{background:#0ea5e9}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="sticky top-0 z-20 backdrop-blur bg-white/80 border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="/client/" class="text-sm text-slate-600 hover:text-slate-900 flex items-center gap-2">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="opacity-70"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Zpƒõt na klientskou sekci
      </a>
      <div class="ml-auto flex flex-wrap items-center gap-2 overflow-x-auto">
        <a href="/client/market/" class="pill bg-white font-medium whitespace-nowrap">Market Scanner</a>
        <a href="/client/real-estate/" class="pill whitespace-nowrap">Real-Estate</a>
        <a href="/client/idea-lab/" class="pill whitespace-nowrap">Idea Lab</a>
        <span class="ml-2 text-xs text-slate-500 border border-slate-200 rounded-full px-2 py-1 select-none whitespace-nowrap">v2</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <div class="flex items-start flex-wrap gap-3 justify-between">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight">Market Scanner</h1>
        <p class="mt-2 text-slate-600 max-w-3xl">
          Vyhledej a filtruj akcie, indexy, forex, krypto a komodity. <b>≈ò√°dek rozklikni</b> pro tezi, podm√≠nky neplatnosti a <b>mini-graf</b> s 1Y rozmez√≠m.
        </p>
      </div>
      <div class="w-full md:w-auto">
        <button id="openAIEdgeTop" class="w-full md:w-auto inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-cyan-600 text-white shadow-sm hover:bg-cyan-700">‚ö° AI Edge ‚Äî Osobn√≠ predikce</button>
        <div class="text-xs text-slate-500 mt-1 md:text-right">Screenshot nebo symbol ‚Üí smƒõr + √∫rovnƒõ + d≈Øvody.</div>
      </div>
    </div>

    <!-- Watchlist / Presety -->
    <div class="mt-4 flex items-center gap-2 flex-wrap">
      <div id="watchlistBar" class="hidden items-center gap-2 flex-wrap">
        <span class="text-sm text-slate-600">Watchlist:</span>
        <div id="watchlistChips" class="flex items-center gap-2 flex-wrap"></div>
      </div>
      <label class="ml-auto inline-flex items-center gap-2 text-sm text-slate-600">
        <input id="wlOnly" type="checkbox" class="rounded text-cyan-600 border-slate-300"> Filtrovat na watchlist
      </label>
    </div>

    <!-- Hot set-upy -->
    <div class="mt-3 flex items-center gap-2 flex-wrap">
      <span class="text-sm text-slate-600">Hot set-upy:</span>
      <button class="pill bg-white hover:bg-slate-50 text-sm" data-setup="breakout">Breakout</button>
      <button class="pill bg-white hover:bg-slate-50 text-sm" data-setup="mean">Mean-reversion</button>
      <button class="pill bg-white hover:bg-slate-50 text-sm" data-setup="earn">Earnings soon</button>
      <button class="pill bg-white hover:bg-slate-50 text-sm" data-setup="vol">Objem ‚Üë</button>
      <button class="pill bg-slate-100 text-sm" data-setup="">Reset</button>
    </div>

    <!-- Toolbar -->
    <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-3">
      <div class="relative md:col-span-2">
        <input id="q" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white outline-none focus:ring-2 focus:ring-slate-200" placeholder="Hledej symbol / n√°zev‚Ä¶" />
        <div class="absolute inset-y-0 right-2 flex items-center text-slate-400 pointer-events-none"><span class="kbd">/</span></div>
      </div>
      <select id="typeFilter" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white outline-none focus:ring-2 focus:ring-slate-200">
        <option value="">V≈°echny typy</option><option value="stock">Akcie</option><option value="crypto">Krypto</option><option value="index">Index</option><option value="forex">Forex</option><option value="commodity">Komodita</option>
      </select>
      <select id="sortBy" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white outline-none focus:ring-2 focus:ring-slate-200">
        <option value="symbol">Se≈ôadit: Symbol</option><option value="price">Se≈ôadit: Cena</option><option value="w1">Se≈ôadit: 1W %</option><option value="conf">Se≈ôadit: Confidence</option>
      </select>
    </div>

    <!-- Table -->
    <div class="mt-5 overflow-x-auto">
      <div class="min-w-[980px] overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
        <div class="table-grid px-4 py-2 text-sm font-medium text-slate-500 bg-slate-50">
          <div></div><div>N√°zev</div><div class="text-right">Cena</div><div class="text-right">1D %</div><div class="text-right">1W %</div><div class="text-center">1Y predikce <span class="text-slate-400">(min / avg / max)</span></div><div class="text-right">Conf.</div><div class="text-right">Akce</div>
        </div>
        <div id="rows"></div>
      </div>
      <div class="flex items-center justify-between mt-3">
        <div id="countLabel" class="text-xs text-slate-500"></div>
        <button id="moreBtn" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50">Zobrazit v≈°e</button>
      </div>
    </div>

    <!-- Insights -->
    <section class="mt-8">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <h2 class="text-xl font-semibold">Rychl√© v√Ωkazy ze zpr√°v (Insights)</h2>
        <div class="flex items-center gap-2">
          <input id="insSearch" class="px-3 py-2 rounded-lg border border-slate-200 bg-white outline-none w-56" placeholder="Hledej v titulc√≠ch‚Ä¶" />
          <select id="insType" class="px-3 py-2 rounded-lg border border-slate-200 bg-white">
            <option value="">V≈°echna aktiva</option><option value="stock">Akcie</option><option value="index">Indexy</option><option value="forex">Forex</option><option value="crypto">Krypto</option><option value="commodity">Komodity</option><option value="macro">Makro</option>
          </select>
          <select id="insSent" class="px-3 py-2 rounded-lg border border-slate-200 bg-white">
            <option value="">V≈°echen sentiment</option><option value="up">Pozitivn√≠ (‚Üë)</option><option value="down">Negativn√≠ (‚Üì)</option><option value="flat">Neutr√°ln√≠ (‚Üî)</option>
          </select>
          <select id="insHorizon" class="px-3 py-2 rounded-lg border border-slate-200 bg-white">
            <option value="D">Horizon: Dny</option><option value="W" selected>Horizon: T√Ωdny</option><option value="M">Horizon: Mƒõs√≠ce</option>
          </select>
          <button id="insRefresh" class="px-4 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50">Aktualizovat</button>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-1">Zde shrnujeme, co posledn√≠ zpr√°vy <em>znamenaj√≠ pro investory</em>, a jak mohou kr√°tkodobƒõ ovlivnit chov√°n√≠ akci√≠ a dal≈°√≠ch aktiv.</p>
      <div id="insights" class="mt-4 grid md:grid-cols-2 gap-3"></div>
      <div id="insEmpty" class="hidden mt-6 text-sm text-slate-500 text-center">Nic nenalezeno pro dan√© filtry.</div>
    </section>

    <p class="mt-6 text-xs text-slate-500">* Demo data. V ostr√© verzi: AI teze + zpr√°vy + ≈æiv√© ceny + alerty serverem.</p>
  </main>

  <!-- ALERT MODAL -->
  <div id="alertOverlay" class="hidden fixed inset-0 z-50 overlay"></div>
  <section id="alertModal" class="hidden fixed inset-0 z-50 p-4 md:p-8 overflow-y-auto">
    <div class="fade-enter max-w-lg mx-auto rounded-2xl border border-slate-200 bg-white shadow-lg overflow-hidden">
      <div class="px-5 py-4 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
        <h3 class="font-semibold">Vytvo≈ôit alert</h3>
        <button id="alertClose" class="btn btn-ghost">Zav≈ô√≠t</button>
      </div>
      <div class="p-5 space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-slate-600">Symbol</label>
            <input id="alertSymbol" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2" readonly>
          </div>
          <div>
            <label class="text-sm text-slate-600">Akt. cena (demo)</label>
            <input id="alertPriceNow" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2" readonly>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm text-slate-600">C√≠lov√° cena</label>
            <input id="alertTarget" type="number" step="0.01" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="nap≈ô. 250">
          </div>
          <div>
            <label class="text-sm text-slate-600">Podm√≠nka</label>
            <select id="alertCond" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2">
              <option value="above">Kdy≈æ cena > c√≠lov√°</option>
              <option value="below">Kdy≈æ cena &lt; c√≠lov√°</option>
            </select>
          </div>
        </div>
        <div>
          <label class="text-sm text-slate-600">Pozn√°mka (voliteln√©)</label>
          <input id="alertNote" class="mt-1 w-full rounded-lg border border-slate-200 px-3 py-2" placeholder="nap≈ô. vstup/exit‚Ä¶">
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button id="alertSave" class="btn btn-primary">Ulo≈æit alert</button>
        </div>
        <p class="text-xs text-slate-500">* Demo ukl√°d√° do localStorage. Pro napojen√≠ na TradingView/TV alerts pou≈æijeme jejich webhook/API.</p>
      </div>
    </div>
  </section>

  <noscript><div class="max-w-6xl mx-auto px-4 py-6 text-rose-700">Pro zobrazen√≠ dat povol JavaScript.</div></noscript>

  <script>
  window.addEventListener('DOMContentLoaded', function(){
    // ===== helpers =====
    var fmt = new Intl.NumberFormat('cs-CZ',{maximumFractionDigits:2});
    var i18n = new Intl.NumberFormat('cs-CZ');
    function pct(v){ return (v>=0?'+':'') + v.toFixed(2) + '%'; }
    function el(q){ return document.querySelector(q); }
    function saveLS(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
    function loadLS(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch(e){ return def } }

    // ===== data =====
    var baseRows = [
      {type:'stock',symbol:'AAPL',name:'Apple Inc.',price:219.85,d1:1.26,w1:2.10,signals:['breakout','vol'],forecast:{min:165,avg:245,max:310,conf:72}},
      {type:'crypto',symbol:'BTCUSD',name:'Bitcoin',price:67200,d1:2.30,w1:6.80,signals:['breakout','vol'],forecast:{min:42000,avg:88000,max:120000,conf:58}},
      {type:'stock',symbol:'NVDA',name:'NVIDIA Corporation',price:241.80,d1:1.85,w1:4.10,signals:['earn','vol'],forecast:{min:128,avg:281,max:498,conf:72}}
    ];
    var extraRows = [
      {type:'stock',symbol:'MSFT',name:'Microsoft Corp.',price:432.2,d1:0.8,w1:2.5,signals:['mean'],forecast:{min:360,avg:480,max:560,conf:69}},
      {type:'stock',symbol:'AMZN',name:'Amazon.com, Inc.',price:176.8,d1:1.1,w1:3.2,signals:['breakout'],forecast:{min:140,avg:210,max:260,conf:65}},
      {type:'stock',symbol:'GOOGL',name:'Alphabet Inc. (Class A)',price:162.4,d1:-0.3,w1:1.7,signals:['mean'],forecast:{min:130,avg:190,max:240,conf:63}},
      {type:'stock',symbol:'META',name:'Meta Platforms, Inc.',price:506.5,d1:1.9,w1:5.1,signals:['vol'],forecast:{min:380,avg:560,max:720,conf:66}},
      {type:'stock',symbol:'TSLA',name:'Tesla, Inc.',price:214.3,d1:-1.2,w1:4.4,signals:['mean','vol'],forecast:{min:150,avg:260,max:340,conf:55}},
      {type:'index',symbol:'SPX',name:'S&P 500 Index',price:5518,d1:0.30,w1:1.2,signals:['breakout'],forecast:{min:5100,avg:5800,max:6300,conf:59}},
      {type:'index',symbol:'NDX',name:'NASDAQ 100',price:19980,d1:0.45,w1:1.6,signals:['breakout','vol'],forecast:{min:17500,avg:21000,max:23500,conf:60}},
      {type:'forex',symbol:'EURUSD',name:'Euro / US Dollar',price:1.086,d1:-0.12,w1:0.30,signals:['mean'],forecast:{min:1.04,avg:1.10,max:1.14,conf:52}},
      {type:'forex',symbol:'USDJPY',name:'US Dollar / Japanese Yen',price:152.2,d1:0.05,w1:-0.20,signals:['mean'],forecast:{min:146,avg:151,max:157,conf:50}},
      {type:'crypto',symbol:'ETHUSD',name:'Ethereum',price:3360,d1:1.9,w1:7.2,signals:['breakout','vol'],forecast:{min:2200,avg:4200,max:5600,conf:56}},
      {type:'commodity',symbol:'XAUUSD',name:'Gold (Spot)',price:2368,d1:-0.2,w1:0.5,signals:['mean'],forecast:{min:2100,avg:2400,max:2650,conf:58}},
      {type:'commodity',symbol:'WTI',name:'Crude Oil WTI',price:81.4,d1:0.6,w1:1.8,signals:['vol'],forecast:{min:70,avg:86,max:98,conf:55}}
    ];

    var showingAll=false, currentSetup='', dataSource=baseRows.slice();
    var watchlist = loadLS('sm_watchlist', []);

    function toggleWatch(symbol){
      var i=watchlist.indexOf(symbol);
      if(i>=0) watchlist.splice(i,1); else watchlist.push(symbol);
      saveLS('sm_watchlist',watchlist); renderWatchlist(); apply();
    }
    function renderWatchlist(){
      var bar=el('#watchlistBar'), chips=el('#watchlistChips'); chips.innerHTML='';
      watchlist.forEach(function(s){
        var b=document.createElement('button'); b.className='pill bg-white hover:bg-slate-50 text-sm'; b.textContent=s;
        b.addEventListener('click',function(){ q.value=s; apply(); });
        b.addEventListener('contextmenu',function(e){e.preventDefault(); toggleWatch(s);});
        chips.appendChild(b);
      });
      bar.classList.toggle('hidden',watchlist.length===0);
    }

    // ===== tabulka render =====
    var container=el('#rows'), countLabel=el('#countLabel'), moreBtn=el('#moreBtn');

    function starSVG(active){return '<svg class="star '+(active?'active':'')+'" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.3l-5.6 3 1.1-6.4L3 9.8l6.4-.9L12 3l2.6 5.9 6.4.9-4.5 4.1 1.1 6.4z"/></svg>'}

    function sparkSVG(r){
      var min=r.forecast.min, avg=r.forecast.avg, max=r.forecast.max, now=r.price;
      var w=460, h=70, p=18;
      function x(val){ return p + ( (val-min)/(max-min) )*(w-2*p); }
      var yMid = h/2;
      return ''+
        '<svg class="spark w-full" viewBox="0 0 '+w+' '+h+'">'+
        '<line class="guide" x1="'+x(min)+'" y1="'+(yMid)+'" x2="'+x(max)+'" y2="'+(yMid)+'"/>'+
        '<path class="min" d="M'+x(min)+' '+(yMid)+' L '+x(min)+' '+(yMid)+'"/>'+
        '<path class="avg" d="M'+x(min)+' '+(yMid)+' L '+x(avg)+' '+(yMid)+'"/>'+
        '<path class="max" d="M'+x(avg)+' '+(yMid)+' L '+x(max)+' '+(yMid)+'"/>'+
        '<line class="now" x1="'+x(now)+'" y1="'+(yMid-16)+'" x2="'+x(now)+'" y2="'+(yMid+16)+'"/>'+
        '</svg>';
    }

    function render(list){
      container.innerHTML='';
      list.forEach(function(r){
        var inWL = watchlist.includes(r.symbol);

        // Hlavn√≠ ≈ô√°dek (klikac√≠)
        var row=document.createElement('div');
        row.className="row row-head border-t border-slate-100";
        row.innerHTML =
          '<div class="table-grid px-4 py-3">'+
          '  <div class="font-semibold cell-nowrap flex items-center gap-1">'+
          '    <span>'+r.symbol+'</span>'+
          '    <svg class="chev w-4 h-4 opacity-60" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'+
          '  </div>'+
          '  <div class="text-slate-700 truncate">'+r.name+'</div>'+
          '  <div class="text-right tabular-nums cell-nowrap">'+fmt.format(r.price)+'</div>'+
          '  <div class="text-right tabular-nums cell-nowrap '+(r.d1>=0?'text-emerald-600':'text-rose-600')+'">'+pct(r.d1)+'</div>'+
          '  <div class="text-right tabular-nums cell-nowrap '+(r.w1>=0?'text-emerald-600':'text-rose-600')+'">'+pct(r.w1)+'</div>'+
          '  <div class="text-center tabular-nums cell-nowrap text-[15px]">'+i18n.format(r.forecast.min)+' / <span class="font-semibold">'+i18n.format(r.forecast.avg)+'</span> / '+i18n.format(r.forecast.max)+'</div>'+
          '  <div class="text-right tabular-nums cell-nowrap">'+r.forecast.conf+'%</div>'+
          '  <div class="actions cell-nowrap">'+
          '    <button class="btn btn-ghost" data-watch="'+r.symbol+'" title="'+(inWL?'Odebrat z watchlistu':'P≈ôidat do watchlistu')+'">'+starSVG(inWL)+'</button>'+
          '    <button class="btn btn-ghost" data-alert="'+r.symbol+'">üîî Alert</button>'+
          '    <button class="btn btn-primary" data-ai="'+r.symbol+'"><span class="ai-full">AI predikce</span><span class="ai-short hidden">AI</span></button>'+
          '  </div>'+
          '</div>';

        // Detail panel
        var det=document.createElement('div');
        det.className="details px-6 pb-5 pt-4 bg-slate-50/60 border-t";
        det.innerHTML =
          '<div class="flex flex-col gap-3">'+
          '  <div class="flex items-start gap-4 flex-wrap">'+
          '    <div class="grow min-w-[320px]">'+ sparkSVG(r) +'</div>'+
          '    <div class="target-badges">'+
          '      <span class="tg"><span class="dot min"></span>Min '+i18n.format(r.forecast.min)+'</span>'+
          '      <span class="tg"><span class="dot avg"></span>Avg '+i18n.format(r.forecast.avg)+'</span>'+
          '      <span class="tg"><span class="dot max"></span>Max '+i18n.format(r.forecast.max)+'</span>'+
          '      <span class="tg"><span class="dot now"></span>Now '+fmt.format(r.price)+'</span>'+
          '    </div>'+
          '  </div>'+
          '  <div class="text-sm text-slate-600">Predikce (1Y): oƒçek√°van√© p√°smo <b>'+i18n.format(r.forecast.min)+' ‚Äì '+i18n.format(r.forecast.max)+'</b>, st≈ôed <b>'+i18n.format(r.forecast.avg)+'</b>. Confidence <b>'+r.forecast.conf+'%</b>.</div>'+
          '  <div class="flex gap-2 flex-wrap pt-1">'+
          '    <button class="btn btn-primary" data-ai="'+r.symbol+'">AI predikce</button>'+
          '    <button class="btn btn-ghost" data-alert="'+r.symbol+'">üîî Vytvo≈ôit alert</button>'+
          '  </div>'+
          '</div>';

        // Append
        container.appendChild(row);
        container.appendChild(det);

        // Toggle details
        row.addEventListener('click', function(e){
          // neklikej, pokud je to tlaƒç√≠tko v akc√≠ch
          if(e.target.closest('.actions') || e.target.closest('button')) return;
          row.classList.toggle('open');
          det.classList.toggle('hidden', false); // detail u≈æ z≈Øst√°v√° v DOM
          if(row.classList.contains('open')){ row.nextSibling.classList.remove('hidden'); } else { row.nextSibling.classList.add('hidden'); }
        });
      });

      // listeners (watch/alert/ai) ‚Äì funguj√≠ i v detailech
      container.querySelectorAll('[data-watch]').forEach(function(b){
        b.addEventListener('click', function(e){ e.stopPropagation(); toggleWatch(this.getAttribute('data-watch')); });
      });
      container.querySelectorAll('[data-alert]').forEach(function(b){
        b.addEventListener('click', function(e){
          e.stopPropagation();
          var s=this.getAttribute('data-alert'); var found=allRows().find(x=>x.symbol===s);
          openAlert(found.symbol, found.price);
        });
      });
      container.querySelectorAll('[data-ai]').forEach(function(b){
        b.addEventListener('click', function(e){
          e.stopPropagation();
          var s=this.getAttribute('data-ai'); aiPredictionDemo(s);
        });
      });

      countLabel.textContent='Zobrazeno: '+list.length+(showingAll?' / '+(baseRows.length+extraRows.length):'');
    }

    function allRows(){ return showingAll ? baseRows.concat(extraRows) : baseRows.slice(); }

    var q=el('#q'), typeFilter=el('#typeFilter'), sortBy=el('#sortBy'), wlOnly=el('#wlOnly');

    function apply(){
      var term=(q.value||'').trim().toLowerCase();
      var pool = showingAll ? baseRows.concat(extraRows) : baseRows.slice();

      if(currentSetup){
        pool = pool.filter(function(r){
          if(currentSetup==='earn') return r.signals?.includes('earn');
          if(currentSetup==='mean') return r.signals?.includes('mean');
          if(currentSetup==='vol')  return r.signals?.includes('vol');
          return r.signals?.includes('breakout');
        });
      }

      var out = pool.filter(function(r){
        var okType = !typeFilter.value || r.type===typeFilter.value;
        var okSearch = !term || r.symbol.toLowerCase().includes(term) || r.name.toLowerCase().includes(term);
        var okWL = !wlOnly.checked || watchlist.includes(r.symbol);
        return okType && okSearch && okWL;
      });

      switch(sortBy.value){
        case 'price': out.sort((a,b)=>b.price-a.price); break;
        case 'w1':    out.sort((a,b)=>b.w1-a.w1); break;
        case 'conf':  out.sort((a,b)=>b.forecast.conf-a.forecast.conf); break;
        default:      out.sort((a,b)=>a.symbol.localeCompare(b.symbol));
      }
      render(out);
    }

    document.querySelectorAll('[data-setup]').forEach(b=>b.addEventListener('click',function(){currentSetup=this.dataset.setup;apply();}));
    q.addEventListener('input',apply);
    typeFilter.addEventListener('change',function(){ syncTypeFromTable(); apply(); });
    sortBy.addEventListener('change',apply);
    wlOnly.addEventListener('change',apply);
    moreBtn.addEventListener('click', function(){ showingAll=!showingAll; this.textContent=showingAll?'Zobrazit m√©nƒõ':'Zobrazit v≈°e'; apply(); });

    // ===== Insights (beze zmƒõn logiky) =====
    var insData=[], insContainer=el('#insights'), insEmpty=el('#insEmpty'),
        insSearch=el('#insSearch'), insType=el('#insType'), insSent=el('#insSent'),
        insHorizon=el('#insHorizon'), insRefresh=el('#insRefresh');

    function impactBadge(sent){ if(sent==='up')return'<span class="badge impact-up">‚Üë Pozitivn√≠</span>'; if(sent==='down')return'<span class="badge impact-down">‚Üì Negativn√≠</span>'; return'<span class="badge impact-flat">‚Üî Neutr√°ln√≠</span>'; }

    function renderInsights(list){
      insContainer.innerHTML=''; if(!list.length){insEmpty.classList.remove('hidden');return;} insEmpty.classList.add('hidden');
      list.forEach(function(n){
        var card=document.createElement('article'); card.className='ins-card p-4';
        var tickers=(n.tickers||[]).map(function(t){return'<button class="pill text-sm bg-white hover:bg-slate-50" data-jump="'+t+'">'+t+'</button>'}).join(' ');
        card.innerHTML =
          '<div class="flex items-start justify-between gap-3">'+
          '<div><div class="text-sm text-slate-500">'+n.source+' ‚Ä¢ '+n.time+'</div><h3 class="mt-0.5 font-semibold">'+n.title+'</h3></div>'+
          '<div class="text-right shrink-0">'+impactBadge(n.sentiment)+'<div class="text-xs text-slate-500 mt-1">Pravdƒõpodobnost: <b>'+n.prob+'%</b></div></div>'+
          '</div>'+
          '<p class="mt-2 text-sm">'+n.explainer+'</p>'+
          (n.take?('<ul class="mt-2 text-sm list-disc pl-5">'+n.take.map(t=>'<li>'+t+'</li>').join('')+'</ul>'):'')+
          '<div class="mt-3 flex flex-wrap gap-2">'+(n.tags||[]).map(t=>'<span class="tag">'+t+'</span>').join('')+'</div>'+
          (tickers?('<div class="mt-3 flex flex-wrap gap-2 items-center"><span class="text-xs text-slate-500">Vztahuje se k:</span>'+tickers+'</div>'):'');
        insContainer.appendChild(card);
      });
      insContainer.querySelectorAll('[data-jump]').forEach(function(b){ b.addEventListener('click',function(){ q.value=this.dataset.jump; apply(); scrollTo({top:0,behavior:'smooth'}); }); });
    }

    function filterInsights(){
      var term=(insSearch.value||'').toLowerCase().trim();
      var list=insData.filter(function(n){
        var okType=!insType.value||n.type===insType.value;
        var okSent=!insSent.value||n.sentiment===insSent.value;
        var okText=!term||n.title.toLowerCase().includes(term);
        return okType&&okSent&&okText;
      });
      if(insType.value!==typeFilter.value){ typeFilter.value=insType.value; }
      renderInsights(list); apply();
    }

    function mockInsights(){
      return [
        { type:'macro', source:'Makro kalend√°≈ô', time:'dnes', sentiment:'up', prob:65,
          title:'Ni≈æ≈°√≠ ne≈æ oƒçek√°van√° inflace (CPI) ‚Äì ochlazen√≠ j√°drov√© slo≈æky',
          explainer:'Slab≈°√≠ CPI zvy≈°uje ≈°anci na d≈ô√≠vƒõj≈°√≠ uvolnƒõn√≠ mƒõnov√© politiky. Diskontn√≠ sazby klesaj√≠ ‚Üí vy≈°≈°√≠ valuace r≈Østov√Ωch titul≈Ø.',
          take:['Pozitivn√≠ skew pro SPX/NDX v horizontu t√Ωdn≈Ø','Duration-sensitive: tech/AI outperform','USD m≈Ø≈æe oslabit; zlato dr≈æ√≠ bid'],
          tags:['Inflace','Sazby','R≈Østov√© akcie'], tickers:['SPX','NDX','AAPL','NVDA']
        },
        { type:'stock', source:'Earnings ‚Ä¢ NVDA', time:'vƒçera', sentiment:'up', prob:70,
          title:'NVDA beat + zv√Ω≈°en√Ω v√Ωhled DC/AI',
          explainer:'Objedn√°vky v datacentrech p≈ôetrv√°vaj√≠, backlog je robustn√≠. Pravdƒõpodobnost pokraƒçov√°n√≠ trendu je vy≈°≈°√≠.',
          take:['Pozitivn√≠ p≈ôelev pro polovodiƒçe (AMD, TSM)','Index NDX citliv√Ω na mega-cap tech'],
          tags:['Earnings','AI','Semiconductors'], tickers:['NVDA','AMD','NDX']
        },
        { type:'crypto', source:'Regulace ‚Ä¢ USA', time:'dnes', sentiment:'down', prob:55,
          title:'P≈ô√≠snƒõj≈°√≠ r√°mec pro krypto burzy',
          explainer:'Kr√°tkodobƒõ tlak na altcoiny kv≈Øli compliance n√°klad≈Øm; BTC/ETH relativnƒõ odolnƒõj≈°√≠ d√≠ky institucion√°ln√≠m tok≈Øm.',
          take:['Defenzivn√≠ rotace: BTC>ALT','Sledovat odliv z risk-on token≈Ø'],
          tags:['Krypto','Regulace'], tickers:['BTCUSD','ETHUSD']
        },
        { type:'commodity', source:'OPEC+', time:'tento t√Ωden', sentiment:'up', prob:58,
          title:'Prodlu≈æen√≠ dobrovoln√Ωch ≈°krt≈Ø tƒõ≈æby ropy',
          explainer:'Tighter supply ‚Üí vy≈°≈°√≠ podlaha cen WTI/Brent. Energetick√Ω sektor m√° zlep≈°en√Ω R:R.',
          take:['XLE a servisn√≠ firmy profituj√≠','Pozor na citlivost SPX na dra≈æ≈°√≠ energii'],
          tags:['Ropa','OPEC','Energie'], tickers:['WTI','SPX']
        },
        { type:'forex', source:'Fed speakers', time:'dnes', sentiment:'flat', prob:52,
          title:'Sm√≠≈°en√© koment√°≈ôe ƒçlen≈Ø Fedu',
          explainer:'Kr√°tkodobƒõ vy≈°≈°√≠ volatilita USD. Bez jasn√©ho smƒõru ‚Äì range trading na EURUSD pravdƒõpodobn√Ω.',
          take:['Preferovat mean-reversion set-upy na hlavn√≠ch p√°rech'],
          tags:['USD','Volatilita'], tickers:['EURUSD','USDJPY']
        }
      ];
    }

    function fetchInsights(){
      var params=new URLSearchParams({horizon:insHorizon.value||'W'});
      return fetch('/api/trader-ai/news?'+params.toString())
        .then(function(r){ if(!r.ok) throw new Error('fail'); return r.json(); })
        .catch(function(){ return mockInsights(); });
    }

    insRefresh.addEventListener('click', function(){
      insRefresh.disabled=true; insRefresh.textContent='Naƒç√≠t√°m‚Ä¶';
      fetchInsights().then(function(data){
        insData=(Array.isArray(data)?data:[]).map(function(n){
          return { type:n.type||n.asset_type||'', source:n.source||'Zpr√°vy', time:n.time||n.when||'nyn√≠',
            sentiment:n.sentiment||n.impact||'flat', prob:n.prob||n.probability||55, title:n.title||n.headline||'‚Äî',
            explainer:n.explainer||n.summary||'', take:n.take||n.actions||[], tags:n.tags||[], tickers:n.tickers||[] };
        });
        filterInsights();
      }).finally(function(){ insRefresh.disabled=false; insRefresh.textContent='Aktualizovat'; });
    });

    insSearch.addEventListener('input',filterInsights);
    insType.addEventListener('change',filterInsights);
    insSent.addEventListener('change',filterInsights);
    insHorizon.addEventListener('change',function(){ /* pro backend */ });

    function syncTypeFromTable(){ if(insType.value!==typeFilter.value){ insType.value=typeFilter.value; } }

    // ===== Alert modal (demo) =====
    var alertOverlay=el('#alertOverlay'), alertModal=el('#alertModal'), alertClose=el('#alertClose'), alertSave=el('#alertSave');
    function openAlert(symbol, priceNow){
      el('#alertSymbol').value=symbol; el('#alertPriceNow').value=fmt.format(priceNow);
      el('#alertTarget').value=''; el('#alertCond').value='above'; el('#alertNote').value='';
      alertOverlay.classList.remove('hidden'); alertModal.classList.remove('hidden');
      requestAnimationFrame(function(){ alertModal.querySelector('.fade-enter').classList.add('fade-enter-active'); });
    }
    function closeAlert(){ alertOverlay.classList.add('hidden'); alertModal.classList.add('hidden'); }
    alertOverlay.addEventListener('click',closeAlert); alertClose.addEventListener('click',closeAlert);

    alertSave.addEventListener('click',function(){
      var alerts=loadLS('sm_alerts',[]);
      var rec={symbol:el('#alertSymbol').value,cond:el('#alertCond').value,target:parseFloat(el('#alertTarget').value),note:el('#alertNote').value||'',created_at:Date.now()};
      if(!isFinite(rec.target)){ alert('Zadej platnou c√≠lovou cenu.'); return; }
      alerts.push(rec); saveLS('sm_alerts',alerts); closeAlert(); alert('Alert ulo≈æen (demo).');
    });

    // ===== AI predikce demo =====
    function aiPredictionDemo(symbol){
      alert('AI predikce pro '+symbol+':\n‚Ä¢ Smƒõr: ‚Üë pravdƒõpodobnost 60‚Äì70%\n‚Ä¢ √örovnƒõ: support/rezistence bl√≠zko min/avg/max (viz panel).');
    }

    // ===== init =====
    renderWatchlist();
    apply();
    insData = mockInsights();
    filterInsights();
  });
  </script>
</body>
</html>
