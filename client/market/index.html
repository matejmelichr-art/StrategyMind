<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StrategyMind ‚Äî Market Console</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script>
    tailwind.config = { theme:{ extend:{ colors:{ brand:{ 50:"#ECFEFF",100:"#CFFAFE",200:"#A5F3FC",300:"#67E8F9",400:"#22D3EE",500:"#06B6D4",600:"#0891B2",700:"#0E7490",800:"#155E75",900:"#164E63"} }}}};
  </script>
  <style>
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .glass{backdrop-filter:blur(10px);background:linear-gradient(180deg,rgba(255,255,255,.75),rgba(255,255,255,.55))}
    .pill{padding:.35rem .6rem;border:1px solid #e2e8f0;border-radius:9999px}
    /* --- mini chart --- */
    .chart .axis{stroke:#CBD5E1}
    .chart .past{stroke:#0ea5e9;stroke-width:2.5;fill:none}
    .chart .base{stroke:#2563eb;stroke-width:2;stroke-dasharray:6 6;fill:none}
    .chart .bull{stroke:#22c55e;stroke-width:2;fill:none;opacity:.7}
    .chart .bear{stroke:#ef4444;stroke-width:2;fill:none;opacity:.7}
    .chart .future{marker-end:url(#arrow)}
    .chart .label{font-size:12px;fill:#334155}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="/client/" class="text-slate-600 hover:text-slate-900 flex items-center gap-2">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Zpƒõt na klientskou sekci
      </a>
      <div class="ml-auto flex items-center gap-2">
        <span class="px-2 py-1 text-xs border border-slate-200 rounded-full">Market Console ‚Ä¢ v0.1</span>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-12 gap-5">
    <!-- Sidebar / knihovna -->
    <aside class="col-span-12 md:col-span-3">
      <div class="glass rounded-2xl border border-white/50 p-4">
        <h3 class="font-semibold">Knihovna</h3>
        <input id="q" class="mt-3 w-full rounded-lg border-slate-200" placeholder="Hledej symbol / n√°zev‚Ä¶" />
        <div class="mt-3 space-y-2" id="tickerList"></div>
        <hr class="my-4">
        <div class="space-y-2">
          <button data-view="news" class="w-full pill bg-white hover:bg-slate-50 text-left">üì∞ News rozbor</button>
          <button data-view="market" class="w-full pill bg-white hover:bg-slate-50 text-left">üìà Market</button>
          <!-- Jarvis je samostatn√° str√°nka -->
          <a href="/client/market/ai.html" class="w-full inline-block pill bg-white hover:bg-slate-50 text-left">ü§ñ Jarvis AI</a>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-3">Tip: dlouh√Ω popis a pozn√°mky k symbolu najde≈° v News a v Jarvisovi.</p>
    </aside>

    <!-- Workspace -->
    <section class="col-span-12 md:col-span-9 space-y-5">
      <!-- TOP summary -->
      <div class="rounded-2xl border border-slate-200 bg-white p-4 flex flex-wrap items-center gap-3">
        <div class="text-slate-700">
          <div class="text-sm">Vybr√°no:</div>
          <div class="text-xl font-semibold" id="pick">‚Äî</div>
        </div>
        <div class="ml-auto flex items-center gap-2">
          <span class="pill text-sm" id="priceBadge">Cena: ‚Äî</span>
          <span class="pill text-sm" id="forecastBadge">1Y: min/avg/max ‚Äî</span>
          <span class="pill text-sm" id="confBadge">Conf: ‚Äî</span>
          <!-- üîå tlaƒç√≠tka na server -->
          <button id="btnAnalyze" class="pill bg-brand-600 text-white hover:bg-brand-700 text-sm">AI analyzovat</button>
          <button id="btnNews" class="pill bg-white hover:bg-slate-50 text-sm">AI news</button>
        </div>
      </div>

      <!-- NEWS -->
      <article id="view-news" class="rounded-2xl border border-slate-200 bg-white p-4">
        <div class="flex items-start justify-between gap-3">
          <h2 class="text-lg font-semibold">üì∞ News rozbor (AI ekonom)</h2>
          <div class="flex gap-2">
            <button id="exportMD" class="pill bg-white hover:bg-slate-50 text-sm">Export MD</button>
            <button id="exportJSON" class="pill bg-white hover:bg-slate-50 text-sm">Export JSON</button>
          </div>
        </div>
        <p class="text-sm text-slate-600 mt-1">Kombinujeme makro + firemn√≠ zpr√°vy do kr√°tk√© investiƒçn√≠ interpretace.</p>
        <div id="newsBody" class="mt-3 prose prose-sm max-w-none"></div>
      </article>

      <!-- MARKET -->
      <article id="view-market" class="rounded-2xl border border-slate-200 bg-white p-4 hidden">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">üìà Market graf + projekce</h2>
          <div class="flex gap-2 text-sm">
            <span class="pill">Optimistic</span>
            <span class="pill">Base</span>
            <span class="pill">Defensive</span>
          </div>
        </div>
        <div class="mt-3">
          <svg id="chart" class="chart w-full" viewBox="0 0 900 300" role="img" aria-label="Price with forecast">
            <defs>
              <marker id="arrow" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L0,6 L6,3 z" fill="#334155"></path>
              </marker>
            </defs>
            <!-- osy -->
            <line class="axis" x1="50" y1="250" x2="850" y2="250"/>
            <line class="axis" x1="50" y1="40" x2="50" y2="250"/>
            <!-- dynamick√Ω obsah -->
            <g id="chart-layer"></g>
          </svg>
        </div>
        <div class="grid md:grid-cols-3 gap-3 mt-3" id="scenarios"></div>
      </article>
    </section>
  </main>

  <script>
  // ===== DEMO DATA ===========================================================
  const DATA = [
    {type:'stock',symbol:'AAPL',name:'Apple Inc.',price:219.85,d1:1.26,w1:2.10,
      forecast:{min:165,avg:245,max:310,conf:72},
      news:[
        "CPI n√≠≈æ ‚Üí pravdƒõpodobnost d≈ô√≠vƒõj≈°√≠ho uvolnƒõn√≠ sazeb.",
        "iPhone mix lep≈°√≠ ne≈æ oƒçek. v USA; ƒå√≠na stabilizace.",
        "Capex do AI/On-device ML ‚Äì margin tailwind 2025."
      ]
    },
    {type:'stock',symbol:'NVDA',name:'NVIDIA Corporation',price:241.8,d1:1.85,w1:4.10,
      forecast:{min:128,avg:281,max:498,conf:72},
      news:[
        "Datacentra backlog > 2Q; ARMs server momentum.",
        "Riziko exportn√≠ch limit≈Ø je ƒç√°steƒçnƒõ zacenƒõn√©.",
        "Konkurenƒçn√≠ tlak ‚Äì sleduj mar≈æe, supply cadence."
      ]
    },
    {type:'crypto',symbol:'BTCUSD',name:'Bitcoin',price:67200,d1:2.30,w1:6.80,
      forecast:{min:42000,avg:88000,max:120000,conf:58},
      news:[
        "ETF inflows dr≈æ√≠ popt√°vku.",
        "Likvidita v√≠kend≈Ø zvy≈°uje volatilitu.",
        "Makro: slab≈°√≠ USD b√Ωv√° pro krypto podp≈Ørn√©."
      ]
    }
  ];

  // ===== STATE + HELPERS =====================================================
  const $ = q => document.querySelector(q);
  const fmt = new Intl.NumberFormat('cs-CZ',{maximumFractionDigits:2});
  const i18n = new Intl.NumberFormat('cs-CZ');

  let current = null;

  function pickSymbol(sym){
    current = DATA.find(x=>x.symbol===sym);
    if(!current) return;
    $('#pick').textContent = `${current.symbol} ‚Ä¢ ${current.name}`;
    $('#priceBadge').textContent = `Cena: ${fmt.format(current.price)}`;
    $('#forecastBadge').textContent = `1Y: ${i18n.format(current.forecast.min)} / ${i18n.format(current.forecast.avg)} / ${i18n.format(current.forecast.max)}`;
    $('#confBadge').textContent = `Conf: ${current.forecast.conf}%`;
    renderNews();
    renderChart();
    renderScenarios();
  }

  // ===== SIDEBAR =============================================================
  const list = $('#tickerList');
  function renderList(filter=''){
    list.innerHTML='';
    DATA.filter(x => (x.symbol+x.name).toLowerCase().includes(filter.toLowerCase()))
      .forEach(r=>{
        const b = document.createElement('button');
        b.className = 'w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100 border border-slate-200';
        b.innerHTML = `<div class="font-medium">${r.symbol}</div><div class="text-xs text-slate-500 truncate">${r.name}</div>`;
        b.onclick=()=>pickSymbol(r.symbol);
        list.appendChild(b);
      });
  }
  renderList(); $('#q').addEventListener('input', e=>renderList(e.target.value));
  pickSymbol(DATA[0].symbol);

  // ===== VIEW SWITCHER (jen News/Market) ====================================
  document.querySelectorAll('[data-view]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const target = btn.getAttribute('data-view');
      ['news','market'].forEach(v=>{
        const el = document.getElementById('view-'+v);
        if (el) el.classList.toggle('hidden', v!==target);
      });
    })
  });

  // ===== NEWS + EXPORT =======================================================
  function renderNews(){
    if(!current) return;
    const html = `
      <div class="text-sm text-slate-700">Ticker: <b>${current.symbol}</b> ‚Ä¢ ${current.name}</div>
      <ul class="mt-2 list-disc pl-5 text-sm">
        ${current.news.map(n=>`<li>${n}</li>`).join('')}
      </ul>
      <p class="mt-2 text-sm text-slate-700">
        <b>Interpretace:</b> ${current.forecast.conf}% jistota; p√°smo ${i18n.format(current.forecast.min)}‚Äì${i18n.format(current.forecast.max)}, st≈ôed ${i18n.format(current.forecast.avg)}.
      </p>`;
    $('#newsBody').innerHTML = html;
  }

  function exportJSON(){
    const out = { symbol: current.symbol, name: current.name, news: current.news, forecast: current.forecast, price: current.price, exported_at: new Date().toISOString() };
    download('news-'+current.symbol+'.json', JSON.stringify(out,null,2));
  }
  function exportMD(){
    const md = `# ${current.symbol} ‚Äî News rozbor\n\n**Firma:** ${current.name}\n\n**Teze (1Y):** min ${current.forecast.min} / avg ${current.forecast.avg} / max ${current.forecast.max} (conf ${current.forecast.conf}%)\n\n## Body\n${current.news.map(n=>'- '+n).join('\n')}\n`;
    download('news-'+current.symbol+'.md', md);
  }
  function download(filename, content){
    const a=document.createElement('a'); a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(content); a.download=filename; a.click();
  }
  $('#exportJSON').onclick=exportJSON; $('#exportMD').onclick=exportMD;

  // ===== MARKET CHART ========================================================
  function renderChart(){
    if(!current) return;
    const g = $('#chart-layer'); g.innerHTML='';

    // demo minul√° trajektorie (line√°rn√≠)
    const pastX0=50, pastX1=500, futX0=pastX1, futX1=850;
    const yMin=40, yMax=250;
    const spanMin=current.forecast.min, spanAvg=current.forecast.avg, spanMax=current.forecast.max;
    const scaleY = v => {
      const lo = spanMin*0.9, hi = spanMax*1.1; // padding
      const t = (v-lo)/(hi-lo); return yMax - t*(yMax-yMin);
    };

    // minulost ‚Äì jednoduch√° ‚Äûklikat√°‚Äú ƒç√°ra
    const past = [0,0.15,0.05,0.3,0.2,0.45,0.35,0.55,0.5,0.6].map((t,i)=>[
      pastX0 + (pastX1-pastX0)*i/9,
      scaleY(spanMin + t*(spanMax-spanMin))
    ]);
    g.appendChild(path('past', past));

    // z√°kladn√≠ futura: current.price -> avg
    const yNow = scaleY(current.price);
    const yAvg = scaleY(spanAvg);
    const yBull = scaleY(spanMax);
    const yBear = scaleY(spanMin);

    g.appendChild(line('base', futX0, yNow, futX1, yAvg));
    g.appendChild(line('bull future', futX0, yNow, futX1, yBull));
    g.appendChild(line('bear future', futX0, yNow, futX1, yBear));

    // popisky
    g.appendChild(text('label', futX1-40, yBull-6, 'Optimistic'));
    g.appendChild(text('label', futX1-40, yAvg-6, 'Base'));
    g.appendChild(text('label', futX1-40, yBear-6, 'Defensive'));
  }

  function path(cls, pts){
    const p=document.createElementNS('http://www.w3.org/2000/svg','path');
    p.setAttribute('class',cls);
    p.setAttribute('d','M '+pts.map(xy=>xy.join(',')).join(' L '));
    return p;
  }
  function line(cls,x1,y1,x2,y2){
    const l=document.createElementNS('http://www.w3.org/2000/svg','line');
    l.setAttribute('class',cls);
    l.setAttribute('x1',x1); l.setAttribute('y1',y1);
    l.setAttribute('x2',x2); l.setAttribute('y2',y2);
    return l;
  }
  function text(cls,x,y,txt){
    const t=document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('class',cls); t.setAttribute('x',x); t.setAttribute('y',y); t.textContent=txt; return t;
  }

  // ===== SC√âN√Å≈òE KARTY =======================================================
  function renderScenarios(){
    const box = $('#scenarios'); box.innerHTML='';
    const spans = [
      {k:'Optimistic',v:current.forecast.max,desc:'R≈Østov√Ω sc√©n√°≈ô (momentum / p≈ô√≠zniv√© makro).'},
      {k:'Base',v:current.forecast.avg,desc:'Z√°klad: konsensus / mean reversion.'},
      {k:'Defensive',v:current.forecast.min,desc:'Riziko: uta≈æen√© podm√≠nky / ≈°oky.'}
    ];
    spans.forEach(s=>{
      const el=document.createElement('div');
      el.className='rounded-xl border border-slate-200 p-3';
      el.innerHTML=`<div class="text-sm text-slate-500">${s.k}</div>
        <div class="text-2xl font-semibold">${i18n.format(s.v)}</div>
        <p class="text-sm text-slate-600 mt-1">${s.desc}</p>`;
      box.appendChild(el);
    });
  }

  /* ====== üîå PROPOJEN√ç NA BACKEND (Cloudflare Worker) =======================
     Nastav√≠me z√°kladn√≠ URL na Worker a v≈°echny po≈æadavky pos√≠l√°me tam.
  -------------------------------------------------------------------------- */
  const API_BASE = "https://tight-field-436e.matejmelichr.workers.dev";

  const API = {
    analyze: (payload) =>
      fetch(`${API_BASE}/api/analyze`, {
        method: 'POST',
        mode: 'cors',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(r => r.ok ? r.json() : Promise.reject(r)),

    news: (payload) =>
      fetch(`${API_BASE}/api/news`, {
        method: 'POST',
        mode: 'cors',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(r => r.ok ? r.json() : Promise.reject(r))
  };

  async function runAnalyze(){
    if(!current) return;
    setBusy('#btnAnalyze', true);
    try{
      const res = await API.analyze({
        symbol: current.symbol,
        price: current.price,
        span: current.forecast,
        context: { source: 'market-console' }
      });
      if(res.span){
        current.forecast = res.span;
        $('#forecastBadge').textContent = `1Y: ${i18n.format(res.span.min)} / ${i18n.format(res.span.avg)} / ${i18n.format(res.span.max)}`;
      }
      if(typeof res.confidence==='number'){
        $('#confBadge').textContent = `Conf: ${res.confidence}%`;
      }
      if(res.reasons && res.reasons.length){
        const ul = res.reasons.map(x=>`<li>${x}</li>`).join('');
        $('#newsBody').innerHTML = `<div class="text-sm text-slate-700">Ticker: <b>${current.symbol}</b> ‚Ä¢ ${current.name}</div><ul class="mt-2 list-disc pl-5 text-sm">${ul}</ul>`;
      }
      renderChart(); renderScenarios();
    }catch(e){
      console.error(e);
      alert('API /api/analyze: chyba po≈æadavku');
    }finally{
      setBusy('#btnAnalyze', false);
    }
  }

  async function runNews(){
    if(!current) return;
    setBusy('#btnNews', true);
    try{
      const res = await API.news({
        symbol: current.symbol,
        horizon: 'W',
        locale: 'cs'
      });
      const bullets = (res.bullets||[]).map(b=>`<li>${b}</li>`).join('');
      const html = `
        <div class="text-sm text-slate-700">Ticker: <b>${current.symbol}</b> ‚Ä¢ ${current.name}</div>
        ${res.summary ? `<p class="mt-2 text-sm text-slate-700">${res.summary}</p>` : ''}
        ${bullets ? `<ul class="mt-2 list-disc pl-5 text-sm">${bullets}</ul>` : ''}
      `;
      $('#newsBody').innerHTML = html;
    }catch(e){
      console.error(e);
      alert('API /api/news: chyba po≈æadavku');
    }finally{
      setBusy('#btnNews', false);
    }
  }

  function setBusy(sel, busy){
    const el = document.querySelector(sel);
    if(!el) return;
    el.disabled = busy;
    el.style.opacity = busy ? .6 : 1;
    el.textContent = busy ? '‚è≥ Prob√≠h√°‚Ä¶' : (sel==='#btnAnalyze' ? 'AI analyzovat' : 'AI news');
  }

  // Handlery tlaƒç√≠tek
  document.getElementById('btnAnalyze').addEventListener('click', runAnalyze);
  document.getElementById('btnNews').addEventListener('click', runNews);
  </script>
</body>
</html>
