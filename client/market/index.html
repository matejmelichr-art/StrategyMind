<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StrategyMind — Market Scanner</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

  <style>
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .row:hover{background:#f8fafc}
    .pill{padding:.375rem .625rem;border-radius:9999px;border:1px solid rgba(15,23,42,.08)}
    .kbd{background:#f3f4f6;padding:.125rem .375rem;border-radius:.25rem;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace;font-size:.75rem}

    /* mini-graf (ponecháno pro případné rozšíření detailu) */
    .spark path.avg{stroke:#2563eb;stroke-width:2;fill:none}
    .spark path.min,.spark path.max{stroke-width:2;fill:none;stroke-dasharray:4 4}
    .spark path.min{stroke:#ef4444}.spark path.max{stroke:#22c55e}
    .spark line.guide{stroke:#94a3b8;stroke-dasharray:4 4;opacity:.6}
    .spark-wrap{display:flex;align-items:center;gap:.75rem}
    .target-badges{display:flex;flex-direction:column;gap:.2rem;font-size:.75rem;line-height:1.1}
    .target-badges .b{display:flex;align-items:center;gap:.4rem;white-space:nowrap}
    .dot{width:.5rem;height:.5rem;border-radius:9999px;display:inline-block}
    .dot.max{background:#22c55e}.dot.avg{background:#2563eb}.dot.min{background:#ef4444}

    /* tabulka – fix sloupce, ať se nic nepřetéká */
    .table-grid{
      display:grid;
      grid-template-columns: 100px 1fr 120px 100px 100px 250px 80px 180px;
      align-items:center;
    }
    .cell-nowrap{white-space:nowrap}
    .actions{display:flex;justify-content:flex-end;gap:.5rem}
    @media (max-width: 1180px){
      .table-grid{ grid-template-columns: 90px 1fr 110px 95px 95px 260px 80px 150px; }
    }

    /* Insights */
    .badge{display:inline-flex;align-items:center;gap:.4rem;border:1px solid rgba(15,23,42,.12);border-radius:9999px;padding:.25rem .55rem;font-size:.75rem}
    .impact-up{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .impact-down{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}
    .impact-flat{background:#f1f5f9;border-color:#cbd5e1;color:#334155}
    .tag{display:inline-block;padding:.15rem .5rem;border:1px solid #e2e8f0;border-radius:9999px;font-size:.7rem;color:#475569;background:#fff}
    .ins-card{border:1px solid #e2e8f0;border-radius:1rem;background:white}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Header -->
  <header class="sticky top-0 z-20 backdrop-blur bg-white/80 border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="/client/" class="text-sm text-slate-600 hover:text-slate-900 flex items-center gap-2">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="opacity-70"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Zpět na klientskou sekci
      </a>
      <div class="ml-auto flex flex-wrap items-center gap-2 overflow-x-auto">
        <a href="/client/market/" class="pill bg-white font-medium whitespace-nowrap">Market Scanner</a>
        <a href="/client/real-estate/" class="pill whitespace-nowrap">Real-Estate</a>
        <a href="/client/idea-lab/" class="pill whitespace-nowrap">Idea Lab</a>
        <span class="ml-2 text-xs text-slate-500 border border-slate-200 rounded-full px-2 py-1 select-none whitespace-nowrap">v2</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <div class="flex items-start flex-wrap gap-3 justify-between">
      <div>
        <h1 class="text-3xl font-semibold tracking-tight">Market Scanner</h1>
        <p class="mt-2 text-slate-600 max-w-3xl">
          Vyhledej a filtruj akcie, indexy, forex, krypto a komodity.
          Řádek <strong>rozklikni</strong> pro tezi, podmínky neplatnosti a <strong>mini-graf</strong>
          s 1Y rozmezím (<em>min / avg / max</em>) + štítky cílových hodnot.
        </p>
      </div>

      <div class="w-full md:w-auto">
        <button id="openAIEdgeTop" class="w-full md:w-auto inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-cyan-600 text-white shadow-sm hover:bg-cyan-700">
          ⚡ AI Edge — Osobní predikce
        </button>
        <div class="text-xs text-slate-500 mt-1 md:text-right">Nahrát screenshot nebo zadat symbol. Okamžitý směr + úrovně + důvody.</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-3">
      <div class="relative md:col-span-2">
        <input id="q" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white outline-none focus:ring-2 focus:ring-slate-200" placeholder="Hledej symbol / název…" />
        <div class="absolute inset-y-0 right-2 flex items-center text-slate-400 pointer-events-none"><span class="kbd">/</span></div>
      </div>
      <select id="typeFilter" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white outline-none focus:ring-2 focus:ring-slate-200">
        <option value="">Všechny typy</option><option value="stock">Akcie</option><option value="crypto">Krypto</option><option value="index">Index</option><option value="forex">Forex</option><option value="commodity">Komodita</option>
      </select>
      <select id="sortBy" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white outline-none focus:ring-2 focus:ring-slate-200">
        <option value="symbol">Seřadit: Symbol</option><option value="price">Seřadit: Cena</option><option value="w1">Seřadit: 1W %</option><option value="conf">Seřadit: Confidence</option>
      </select>
    </div>

    <!-- Table -->
    <div class="mt-5 overflow-x-auto">
      <div class="min-w-[980px] overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
        <!-- head -->
        <div class="table-grid px-4 py-2 text-sm font-medium text-slate-500 bg-slate-50">
          <div>Symbol</div>
          <div>Název</div>
          <div class="text-right">Cena</div>
          <div class="text-right">1D %</div>
          <div class="text-right">1W %</div>
          <div class="text-center">1Y predikce <span class="text-slate-400">(min / avg / max)</span></div>
          <div class="text-right">Conf.</div>
          <div class="text-right">Akce</div>
        </div>
        <div id="rows"></div>
      </div>

      <!-- More / Less -->
      <div class="flex items-center justify-between mt-3">
        <div id="countLabel" class="text-xs text-slate-500"></div>
        <button id="moreBtn" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50">
          Zobrazit vše
        </button>
      </div>
    </div>

    <!-- Insights / News-driven explanation -->
    <section class="mt-8">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <h2 class="text-xl font-semibold">Rychlé výkazy ze zpráv (Insights)</h2>
        <div class="flex items-center gap-2">
          <input id="insSearch" class="px-3 py-2 rounded-lg border border-slate-200 bg-white outline-none w-56" placeholder="Hledej v titulcích…" />
          <select id="insType" class="px-3 py-2 rounded-lg border border-slate-200 bg-white">
            <option value="">Všechna aktiva</option>
            <option value="stock">Akcie</option>
            <option value="index">Indexy</option>
            <option value="forex">Forex</option>
            <option value="crypto">Krypto</option>
            <option value="commodity">Komodity</option>
            <option value="macro">Makro</option>
          </select>
          <select id="insSent" class="px-3 py-2 rounded-lg border border-slate-200 bg-white">
            <option value="">Všechen sentiment</option>
            <option value="up">Pozitivní (↑)</option>
            <option value="down">Negativní (↓)</option>
            <option value="flat">Neutrální (↔)</option>
          </select>
          <select id="insHorizon" class="px-3 py-2 rounded-lg border border-slate-200 bg-white">
            <option value="D">Horizon: Dny</option>
            <option value="W" selected>Horizon: Týdny</option>
            <option value="M">Horizon: Měsíce</option>
          </select>
          <button id="insRefresh" class="px-4 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50">Aktualizovat</button>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-1">Zde shrnujeme, co poslední zprávy <em>znamenají pro investory</em>, a jak mohou krátkodobě ovlivnit chování akcií, indexů a dalších tříd aktiv.</p>

      <div id="insights" class="mt-4 grid md:grid-cols-2 gap-3"></div>

      <div id="insEmpty" class="hidden mt-6 text-sm text-slate-500 text-center">Nic nenalezeno pro dané filtry.</div>
    </section>

    <p class="mt-6 text-xs text-slate-500">* Demo verze se statickými daty. V ostré verzi připojíme AI teze + zprávy + živé ceny.</p>
  </main>

  <noscript><div class="max-w-6xl mx-auto px-4 py-6 text-rose-700">Pro zobrazení dat povol JavaScript.</div></noscript>

  <script>
  window.addEventListener('DOMContentLoaded', function(){
    // ===== helpers =====
    var fmt = new Intl.NumberFormat('cs-CZ',{maximumFractionDigits:2});
    function pct(v){ return (v>=0?'+':'') + v.toFixed(2) + '%'; }

    // Základní 3 řádky (krátký výpis)
    var baseRows = [
      {type:'stock',symbol:'AAPL',name:'Apple Inc.',price:219.85,d1:1.26,w1:2.10,forecast:{min:165,avg:245,max:310,conf:72}},
      {type:'crypto',symbol:'BTCUSD',name:'Bitcoin',price:67200,d1:2.30,w1:6.80,forecast:{min:42000,avg:88000,max:120000,conf:58}},
      {type:'stock',symbol:'NVDA',name:'NVIDIA Corporation',price:241.80,d1:1.85,w1:4.10,forecast:{min:128,avg:281,max:498,conf:72}}
    ];

    // Rozšířený seznam
    var extraRows = [
      {type:'stock',symbol:'MSFT',name:'Microsoft Corp.',price:432.2,d1:0.8,w1:2.5,forecast:{min:360,avg:480,max:560,conf:69}},
      {type:'stock',symbol:'AMZN',name:'Amazon.com, Inc.',price:176.8,d1:1.1,w1:3.2,forecast:{min:140,avg:210,max:260,conf:65}},
      {type:'stock',symbol:'GOOGL',name:'Alphabet Inc. (Class A)',price:162.4,d1:-0.3,w1:1.7,forecast:{min:130,avg:190,max:240,conf:63}},
      {type:'stock',symbol:'META',name:'Meta Platforms, Inc.',price:506.5,d1:1.9,w1:5.1,forecast:{min:380,avg:560,max:720,conf:66}},
      {type:'stock',symbol:'TSLA',name:'Tesla, Inc.',price:214.3,d1:-1.2,w1:4.4,forecast:{min:150,avg:260,max:340,conf:55}},
      {type:'index',symbol:'SPX',name:'S&P 500 Index',price:5518,d1:0.30,w1:1.2,forecast:{min:5100,avg:5800,max:6300,conf:59}},
      {type:'index',symbol:'NDX',name:'NASDAQ 100',price:19980,d1:0.45,w1:1.6,forecast:{min:17500,avg:21000,max:23500,conf:60}},
      {type:'forex',symbol:'EURUSD',name:'Euro / US Dollar',price:1.086,d1:-0.12,w1:0.30,forecast:{min:1.04,avg:1.10,max:1.14,conf:52}},
      {type:'forex',symbol:'USDJPY',name:'US Dollar / Japanese Yen',price:152.2,d1:0.05,w1:-0.20,forecast:{min:146,avg:151,max:157,conf:50}},
      {type:'crypto',symbol:'ETHUSD',name:'Ethereum',price:3360,d1:1.9,w1:7.2,forecast:{min:2200,avg:4200,max:5600,conf:56}},
      {type:'commodity',symbol:'XAUUSD',name:'Gold (Spot)',price:2368,d1:-0.2,w1:0.5,forecast:{min:2100,avg:2400,max:2650,conf:58}},
      {type:'commodity',symbol:'WTI',name:'Crude Oil WTI',price:81.4,d1:0.6,w1:1.8,forecast:{min:70,avg:86,max:98,conf:55}}
    ];

    var showingAll = false;
    var dataSource = baseRows.slice();

    var container = document.getElementById('rows');
    var countLabel = document.getElementById('countLabel');
    var moreBtn = document.getElementById('moreBtn');

    function render(list){
      container.innerHTML='';
      list.forEach(function(r){
        var row=document.createElement('div'); row.className="row border-t border-slate-100";
        row.innerHTML =
          '<div class="table-grid px-4 py-3">'
          +  '<div class="font-semibold cell-nowrap">'+r.symbol+'</div>'
          +  '<div class="text-slate-700 truncate">'+r.name+'</div>'
          +  '<div class="text-right tabular-nums cell-nowrap">'+fmt.format(r.price)+'</div>'
          +  '<div class="text-right tabular-nums cell-nowrap '+(r.d1>=0?'text-emerald-600':'text-rose-600')+'">'+pct(r.d1)+'</div>'
          +  '<div class="text-right tabular-nums cell-nowrap '+(r.w1>=0?'text-emerald-600':'text-rose-600')+'">'+pct(r.w1)+'</div>'
          +  '<div class="text-center tabular-nums cell-nowrap text-[15px]">'
          +    (new Intl.NumberFormat('cs-CZ')).format(r.forecast.min)+' / '
          +    '<span class="font-semibold">'+(new Intl.NumberFormat('cs-CZ')).format(r.forecast.avg)+'</span> / '
          +    (new Intl.NumberFormat('cs-CZ')).format(r.forecast.max)
          +  '</div>'
          +  '<div class="text-right tabular-nums cell-nowrap">'+r.forecast.conf+'%</div>'
          +  '<div class="actions cell-nowrap">'
          +    '<button class="px-3 py-1.5 text-sm rounded-lg bg-cyan-600 text-white hover:bg-cyan-700 min-w-[120px]" data-ai>AI predikce</button>'
          +  '</div>'
          +'</div>';
        container.appendChild(row);
      });
      countLabel.textContent = 'Zobrazeno: ' + list.length + (showingAll ? ' / ' + (baseRows.length + extraRows.length) : '');
    }

    var q=document.getElementById('q'),
        typeFilter=document.getElementById('typeFilter'),
        sortBy=document.getElementById('sortBy');

    function apply(){
      var term=(q.value||'').trim().toLowerCase();
      var out = dataSource.filter(function(r){
        var okType = !typeFilter.value || r.type===typeFilter.value;
        var okSearch = !term || r.symbol.toLowerCase().indexOf(term)>=0 || r.name.toLowerCase().indexOf(term)>=0;
        return okType && okSearch;
      });
      switch(sortBy.value){
        case 'price': out.sort(function(a,b){return b.price-a.price}); break;
        case 'w1':    out.sort(function(a,b){return b.w1-a.w1});     break;
        case 'conf':  out.sort(function(a,b){return b.forecast.conf-a.forecast.conf}); break;
        default:      out.sort(function(a,b){return a.symbol.localeCompare(b.symbol)});
      }
      render(out);
    }

    q.addEventListener('input',apply);
    typeFilter.addEventListener('change',apply);
    sortBy.addEventListener('change',apply);

    moreBtn.addEventListener('click', function(){
      showingAll = !showingAll;
      dataSource = showingAll ? baseRows.concat(extraRows) : baseRows.slice();
      moreBtn.textContent = showingAll ? 'Zobrazit méně' : 'Zobrazit vše';
      apply();
    });

    // ===== Insights (news → co to znamená) =====
    var insData = []; // bude naplněno z backendu nebo z mocku
    var insContainer = document.getElementById('insights');
    var insEmpty = document.getElementById('insEmpty');
    var insSearch = document.getElementById('insSearch');
    var insType = document.getElementById('insType');
    var insSent = document.getElementById('insSent');
    var insHorizon = document.getElementById('insHorizon');
    var insRefresh = document.getElementById('insRefresh');

    function impactBadge(sent){
      if(sent==='up')   return '<span class="badge impact-up">↑ Pozitivní</span>';
      if(sent==='down') return '<span class="badge impact-down">↓ Negativní</span>';
      return '<span class="badge impact-flat">↔ Neutrální</span>';
    }

    function renderInsights(list){
      insContainer.innerHTML='';
      if(!list.length){ insEmpty.classList.remove('hidden'); return; }
      insEmpty.classList.add('hidden');

      list.forEach(function(n){
        var card = document.createElement('article');
        card.className = 'ins-card p-4';
        card.innerHTML =
          '<div class="flex items-start justify-between gap-3">'
          +  '<div>'
          +    '<div class="text-sm text-slate-500">'+n.source+' • '+n.time+'</div>'
          +    '<h3 class="mt-0.5 font-semibold">'+n.title+'</h3>'
          +  '</div>'
          +  '<div class="text-right shrink-0">'
          +    impactBadge(n.sentiment)
          +    '<div class="text-xs text-slate-500 mt-1">Pravděpodobnost: <b>'+n.prob+'%</b></div>'
          +  '</div>'
          +'</div>'
          +'<p class="mt-2 text-sm">'+n.explainer+'</p>'
          + (n.take?('<ul class="mt-2 text-sm list-disc pl-5">'+n.take.map(function(t){return '<li>'+t+'</li>'}).join('')+'</ul>'):'')
          +'<div class="mt-3 flex flex-wrap gap-2">'
          +  (n.tags||[]).map(function(t){return '<span class="tag">'+t+'</span>'}).join('')
          +'</div>';
        insContainer.appendChild(card);
      });
    }

    function filterInsights(){
      var term = (insSearch.value||'').toLowerCase().trim();
      var list = insData.filter(function(n){
        var okType = !insType.value || n.type===insType.value;
        var okSent = !insSent.value || n.sentiment===insSent.value;
        var okText = !term || n.title.toLowerCase().indexOf(term)>=0;
        return okType && okSent && okText;
      });
      renderInsights(list);
    }

    function mockInsights(){
      // stručné, investor-first
      return [
        {
          type:'macro', source:'Makro kalendář', time:'dnes', sentiment:'up', prob:65,
          title:'Nižší než očekávaná inflace (CPI) – ochlazení jádrové složky',
          explainer:'Slabší CPI zvyšuje šanci na dřívější uvolnění měnové politiky. Diskontní sazby klesají → vyšší valuace růstových titulů.',
          take:['Pozitivní skew pro SPX/NDX v horizontu týdnů','Duration-sensitive: tech/AI outperform','USD může oslabit; zlato drží bid'],
          tags:['Inflace','Sazby','Růstové akcie'], sentimentImpact:'+'
        },
        {
          type:'stock', source:'Earnings • NVDA', time:'včera', sentiment:'up', prob:70,
          title:'NVDA beat + zvýšený výhled DC/AI',
          explainer:'Objednávky v datacentrech přetrvávají, backlog je robustní. Pravděpodobnost pokračování trendu je vyšší.',
          take:['Pozitivní přelev pro polovodiče (AMD, TSM)','Index NDX citlivý na mega-cap tech'],
          tags:['Earnings','AI','Semiconductors']
        },
        {
          type:'crypto', source:'Regulace • USA', time:'dnes', sentiment:'down', prob:55,
          title:'Přísnější rámec pro krypto burzy',
          explainer:'Krátkodobě tlak na altcoiny kvůli compliance nákladům; BTC/ETH relativně odolnější díky institucionálním tokům.',
          take:['Defenzivní rotace: BTC>ALT','Sledovat odliv z risk-on tokenů'],
          tags:['Krypto','Regulace']
        },
        {
          type:'commodity', source:'OPEC+', time:'tento týden', sentiment:'up', prob:58,
          title:'Prodlužení dobrovolných škrtů těžby ropy',
          explainer:'Tighter supply → vyšší podlaha cen WTI/Brent. Energetický sektor má zlepšený R:R.',
          take:['XLE a servisní firmy profitují','Pozor na citlivost SPX na dražší energii'],
          tags:['Ropa','OPEC','Energie']
        },
        {
          type:'forex', source:'Fed speakers', time:'dnes', sentiment:'flat', prob:52,
          title:'Smíšené komentáře členů Fedu',
          explainer:'Krátkodobě vyšší volatilita USD. Bez jasného směru – range trading na EURUSD pravděpodobný.',
          take:['Preferovat mean-reversion set-upy na hlavních párech'],
          tags:['USD','Volatilita']
        }
      ];
    }

    function fetchInsights(){
      // pokus o backend, fallback na mock
      var params = new URLSearchParams({
        horizon: insHorizon.value || 'W'
      });
      return fetch('/api/trader-ai/news?'+params.toString())
        .then(function(r){ if(!r.ok) throw new Error('fail'); return r.json(); })
        .catch(function(){ return mockInsights(); });
    }

    insRefresh.addEventListener('click', function(){
      insRefresh.disabled = true; insRefresh.textContent = 'Načítám…';
      fetchInsights().then(function(data){
        // normalizace: pokud backend, mapuj na náš formát
        insData = (Array.isArray(data)?data:[]).map(function(n){
          return {
            type: n.type || n.asset_type || '',
            source: n.source || 'Zprávy',
            time: n.time || n.when || 'nyní',
            sentiment: n.sentiment || n.impact || 'flat',
            prob: n.prob || n.probability || 55,
            title: n.title || n.headline || '—',
            explainer: n.explainer || n.summary || '',
            take: n.take || n.actions || [],
            tags: n.tags || []
          };
        });
        filterInsights();
      }).finally(function(){
        insRefresh.disabled = false; insRefresh.textContent = 'Aktualizovat';
      });
    });

    insSearch.addEventListener('input', filterInsights);
    insType.addEventListener('change', filterInsights);
    insSent.addEventListener('change', filterInsights);
    insHorizon.addEventListener('change', function(){ /* jen pro backend */ });

    // init
    apply();
    // načti počáteční mock
    insData = mockInsights();
    filterInsights();
  });
  </script>
</body>
</html>
