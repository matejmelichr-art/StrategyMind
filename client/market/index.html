<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StrategyMind – Market Scanner</title>
  <link rel="icon" href="/StrategyMind_App_Icon.jpg" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js pro mini graf v rozbaleném detailu -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .card { @apply bg-white/80 backdrop-blur shadow-sm ring-1 ring-black/5 rounded-2xl; }
    .muted { @apply text-slate-500; }
    .chip  { @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium; }
    .btn   { @apply inline-flex items-center gap-2 rounded-xl px-3 py-1.5 text-sm font-medium bg-slate-900 text-white hover:bg-slate-800; }
    .th    { @apply text-left text-xs font-medium text-slate-500 uppercase tracking-wide; }
    .td    { @apply py-3.5 align-middle; }
    .kpi-up   { @apply text-emerald-600 font-medium; }
    .kpi-down { @apply text-rose-600 font-medium; }
    .caret { transition: transform .2s ease; }
    .spark-wrap { width: 220px; height: 90px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="mx-auto max-w-6xl px-4 pt-6">
    <a href="/client/" class="underline underline-offset-2 text-slate-700 hover:text-slate-900">&larr; Zpět na klientskou sekci</a>
  </header>

  <main class="mx-auto max-w-6xl px-4 pb-24">
    <div class="mt-6 mb-6">
      <h1 class="text-3xl font-semibold tracking-tight">Market Scanner</h1>
      <p class="muted mt-1">
        Vyhledej a filtruj akcie, indexy a krypto. Řádek <strong>rozklikni</strong> pro tezi predikce,
        podmínky neplatnosti a <strong>mini-graf</strong> s 1Y rozmezím (<em>min / avg / max</em>).
        V demu jsou statická data.
      </p>
    </div>

    <!-- Filtry -->
    <div class="mb-4 grid gap-3 md:grid-cols-3">
      <input id="q" type="search" placeholder="Hledej symbol / název…" class="card w-full px-3 py-2" />
      <select id="typeFilter" class="card px-3 py-2">
        <option value="">Všechny typy</option>
        <option value="stock">Akcie</option>
        <option value="crypto">Krypto</option>
        <option value="index">Indexy</option>
      </select>
      <select id="sortBy" class="card px-3 py-2">
        <option value="symbol">Seřadit: Symbol</option>
        <option value="price">Cena</option>
        <option value="conf">Confidence</option>
      </select>
    </div>

    <!-- Tabulka -->
    <div class="card overflow-hidden">
      <table class="w-full min-w-[820px]">
        <thead class="bg-slate-50">
          <tr>
            <th class="th px-4 py-3"></th>
            <th class="th px-4 py-3">Symbol</th>
            <th class="th px-4 py-3">Název</th>
            <th class="th px-4 py-3 text-right">Cena</th>
            <th class="th px-4 py-3 text-right">1D %</th>
            <th class="th px-4 py-3 text-right">1W %</th>
            <th class="th px-4 py-3 text-right">1Y predikce<br><span class="muted normal-case">min / avg / max</span></th>
            <th class="th px-4 py-3 text-right">Conf.</th>
          </tr>
        </thead>
        <tbody id="rows" class="divide-y divide-slate-100 bg-white"></tbody>
      </table>
    </div>

    <div class="mt-6">
      <a class="btn" href="#" onclick="alert('V demu generujeme jen ukázkový markdown.'); return false;">Stáhnout report (MD)</a>
    </div>
  </main>

  <script>
    // ---------------------- DEMO DATA ----------------------
    const DATA = [
      {
        symbol: "AAPL", name: "Apple Inc.", type: "stock",
        price: 219.85, d1: 1.26, w1: 2.10, conf: 0.72,
        forecast: { min: 165, avg: 245, max: 310, hist: [175,185,192,188,197,206,201,210] },
        thesis: "Růst ekosystému, expanze marží, nové produkty.",
        invalid: "Breakdown pod 195 s objemy a slabý guidance."
      },
      {
        symbol: "BTCUSD", name: "Bitcoin", type: "crypto",
        price: 67200, d1: 2.30, w1: 6.80, conf: 0.58,
        forecast: { min: 42000, avg: 88000, max: 120000, hist: [52000,56000,59000,57000,61000,65000,64000,67200] },
        thesis: "ETF poptávka, halving, digitální zlato.",
        invalid: "Regulační tlak, silný risk-off, útok na síť."
      },
      {
        symbol: "NVDA", name: "NVIDIA Corporation", type: "stock",
        price: 241.80, d1: 1.85, w1: 4.10, conf: 0.72,
        forecast: { min: 128, avg: 281, max: 498, hist: [150,165,172,168,183,199,205,242] },
        thesis: "AI akceleruje poptávku, rozšíření portfolia.",
        invalid: "Zpomalení datacenter / geopolitická rizika."
      }
    ];

    // ---------------------- UTIL ----------------------
    const el = (s) => document.querySelector(s);
    const fmtPrice = v => v >= 1000 ? v.toLocaleString("cs-CZ") : v.toLocaleString("cs-CZ", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const fmtPct   = v => (v >= 0 ? `+${v.toFixed(2)}%` : `${v.toFixed(2)}%`);

    // ---------------------- RENDER ROWS ----------------------
    const $tbody = el("#rows");
    function renderRows(list) {
      $tbody.innerHTML = "";
      list.forEach((r, idx) => {
        // hlavní řádek
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-50 cursor-pointer";
        tr.dataset.idx = idx;
        tr.innerHTML = `
          <td class="td px-4 w-8"><span class="caret inline-block rotate-0">▸</span></td>
          <td class="td px-4 font-semibold">${r.symbol}</td>
          <td class="td px-4">${r.name}</td>
          <td class="td px-4 text-right tabular-nums">${fmtPrice(r.price)}</td>
          <td class="td px-4 text-right tabular-nums ${r.d1>=0?'kpi-up':'kpi-down'}">${fmtPct(r.d1)}</td>
          <td class="td px-4 text-right tabular-nums ${r.w1>=0?'kpi-up':'kpi-down'}">${fmtPct(r.w1)}</td>
          <td class="td px-4 text-right tabular-nums">
            ${fmtPrice(r.forecast.min)} <span class="muted">/</span>
            <strong>${fmtPrice(r.forecast.avg)}</strong> <span class="muted">/</span>
            ${fmtPrice(r.forecast.max)}
          </td>
          <td class="td px-4 text-right tabular-nums">${Math.round(r.conf*100)}%</td>
        `;
        $tbody.appendChild(tr);

        // detail řádek (skrytý)
        const dr = document.createElement("tr");
        dr.className = "hidden bg-slate-50/60";
        dr.dataset.detailFor = idx;
        dr.innerHTML = `
          <td></td>
          <td colspan="7" class="px-4 pb-4">
            <div class="mt-1 grid gap-4 md:grid-cols-[1fr_240px]">
              <div class="card p-4">
                <div class="flex items-center justify-between mb-2">
                  <div class="text-sm font-medium">Mini-graf – 1Y (demo)</div>
                  <div class="muted text-xs">Plná čára: avg • čárkovaně: min/max</div>
                </div>
                <div class="spark-wrap"><canvas id="spark-${idx}" width="220" height="90"></canvas></div>
              </div>
              <aside class="card p-4 text-sm space-y-2">
                <p class="muted text-xs">Teze &amp; podmínky</p>
                <p><span class="chip bg-emerald-50 text-emerald-700 mr-2">Teze</span>${r.thesis}</p>
                <p><span class="chip bg-rose-50 text-rose-700 mr-2">Neplatí, pokud</span>${r.invalid}</p>
              </aside>
            </div>
          </td>
        `;
        $tbody.appendChild(dr);
      });
    }

    renderRows(DATA);

    // ---------------------- TOGGLE DETAIL + DRAW SPARK ----------------------
    const charts = {}; // cache Chart.js instancí
    function drawSpark(idx, row) {
      if (charts[idx]) return; // už vykresleno
      const ctx = document.getElementById(`spark-${idx}`);
      if (!ctx) return;

      const labels = ["Nyní", "1Y"];
      const avg = [row.price, row.forecast.avg];
      const min = [row.price, row.forecast.min];
      const max = [row.price, row.forecast.max];

      charts[idx] = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Avg", data: avg, borderWidth: 2, tension: 0.25 },
            { label: "Min", data: min, borderDash: [6,4], borderWidth: 1.5, tension: 0.25 },
            { label: "Max", data: max, borderDash: [6,4], borderWidth: 1.5, tension: 0.25 },
          ]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { enabled: false } },
          scales: {
            x: { display: false },
            y: { display: false }
          },
          elements: { point: { radius: 0 } }
        }
      });
    }

    // klik na řádek – toggle detail
    $tbody.addEventListener("click", (e) => {
      const tr = e.target.closest("tr[data-idx]");
      if (!tr) return;
      const idx = +tr.dataset.idx;
      const caret = tr.querySelector(".caret");
      const detail = $tbody.querySelector(`tr[data-detail-for="${idx}"]`);
      const isOpen = !detail.classList.contains("hidden");
      // zavři/otevři
      if (isOpen) {
        detail.classList.add("hidden");
        caret.style.transform = "rotate(0deg)";
      } else {
        detail.classList.remove("hidden");
        caret.style.transform = "rotate(90deg)";
        // vykresli mini-graf při prvním otevření
        drawSpark(idx, DATA[idx]);
      }
    });

    // ---------------------- FILTRY/ŘAZENÍ ----------------------
    function applyFilters() {
      const q = el("#q").value.trim().toLowerCase();
      const t = el("#typeFilter").value;
      const s = el("#sortBy").value;
      let list = DATA.filter(r =>
        (!t || r.type === t) &&
        (!q || r.symbol.toLowerCase().includes(q) || r.name.toLowerCase().includes(q))
      );
      list.sort((a,b) => {
        if (s === "price") return b.price - a.price;
        if (s === "conf")  return b.conf  - a.conf;
        return a.symbol.localeCompare(b.symbol);
      });
      renderRows(list);
      // zahoď staré chart instance (re-render tabulky)
      Object.values(charts).forEach(ch => ch.destroy());
      Object.keys(charts).forEach(k => delete charts[k]);
    }
    ["#q","#typeFilter","#sortBy"].forEach(id => el(id).addEventListener("input", applyFilters));
  </script>
</body>
</html>
