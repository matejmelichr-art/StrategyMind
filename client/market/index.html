<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StrategyMind — Market Scanner (demo v2)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    html,body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .row:hover { background: #f8fafc; }
    .pill { padding:.375rem .625rem; border-radius:9999px; border:1px solid rgba(15,23,42,.08); }
    .kbd { background:#f3f4f6; padding:.125rem .375rem; border-radius:.25rem; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; font-size:.75rem; }
    /* Mini-graf */
    .spark path.avg   { stroke:#2563eb; stroke-width: 2; fill: none; }
    .spark path.min,
    .spark path.max   { stroke-width: 2; fill: none; stroke-dasharray: 4 4; }
    .spark path.min   { stroke:#ef4444; }
    .spark path.max   { stroke:#22c55e; }
    .spark line.guide { stroke:#94a3b8; stroke-dasharray:4 4; opacity:.6; }
    .spark-wrap { display:flex; align-items:center; gap:.75rem; }
    .target-badges { display:flex; flex-direction:column; gap:.2rem; font-size:.75rem; line-height:1.1; }
    .target-badges .b { display:flex; align-items:center; gap:.4rem; white-space:nowrap; }
    .dot { width:.5rem; height:.5rem; border-radius:9999px; display:inline-block; }
    .dot.max { background:#22c55e; } .dot.avg { background:#2563eb; } .dot.min { background:#ef4444; }
    .skeleton { background:linear-gradient(90deg,#f3f4f6 25%,#e5e7eb 37%,#f3f4f6 63%); background-size:400% 100%; animation:sh 1.2s ease-in-out infinite; }
    @keyframes sh{0%{background-position:100% 0}100%{background-position:0 0}}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-20 backdrop-blur bg-white/80 border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <a href="/client/" class="text-sm text-slate-600 hover:text-slate-900 flex items-center gap-2">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="opacity-70"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Zpět na klientskou sekci
      </a>
      <div class="ml-auto flex items-center gap-2">
        <a href="/client/market/" class="pill bg-white font-medium">Market Scanner</a>
        <a href="/client/real-estate/" class="pill">Real-Estate</a>
        <a href="/client/idea-lab/" class="pill">Idea Lab</a>
        <span class="ml-2 text-xs text-slate-500 border border-slate-200 rounded-full px-2 py-1 select-none">v2</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-semibold tracking-tight">Market Scanner</h1>
    <p class="mt-2 text-slate-600 max-w-3xl">
      Vyhledej a filtruj akcie, indexy, forex, krypto a komodity. Řádek <strong>rozklikni</strong> pro tezi predikce,
      podmínky neplatnosti a <strong>mini-graf</strong> s 1Y rozmezím (<em>min / avg / max</em>) + štítky cílových hodnot.
      V demu jsou statická data, ale tickery se načítají z <code>assets/universe-lite.json</code>.
    </p>

    <!-- Toolbar -->
    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-3">
      <div class="relative">
        <input id="q" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white outline-none focus:ring-2 focus:ring-slate-200"
               placeholder="Hledej symbol / název…" />
        <div class="absolute inset-y-0 right-2 flex items-center text-slate-400 pointer-events-none">
          <span class="kbd">/</span>
        </div>
      </div>
      <select id="typeFilter" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white outline-none focus:ring-2 focus:ring-slate-200">
        <option value="">Všechny typy</option>
        <option value="stock">Akcie</option>
        <option value="index">Index</option>
        <option value="forex">Forex</option>
        <option value="crypto">Krypto</option>
        <option value="commodity">Komodita</option>
      </select>
      <select id="sortBy" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white outline-none focus:ring-2 focus:ring-slate-200">
        <option value="symbol">Seřadit: Symbol</option>
        <option value="price">Seřadit: Cena</option>
        <option value="w1">Seřadit: 1W %</option>
        <option value="conf">Seřadit: Confidence</option>
      </select>
    </div>

    <!-- Table -->
    <div class="mt-5 overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
      <div class="grid grid-cols-[110px,1fr,120px,110px,110px,230px,90px,90px] px-4 py-2 text-sm font-medium text-slate-500 bg-slate-50">
        <div>Symbol</div>
        <div>Název</div>
        <div class="text-right">Cena</div>
        <div class="text-right">1D %</div>
        <div class="text-right">1W %</div>
        <div class="text-center">1Y predikce <span class="text-slate-400">(min / avg / max)</span></div>
        <div class="text-right">Conf.</div>
        <div></div>
      </div>
      <div id="rows"></div>
      <div id="loading" class="px-4 py-6 hidden">
        <div class="h-6 w-2/3 rounded skeleton mb-3"></div>
        <div class="h-6 w-full rounded skeleton mb-2"></div>
        <div class="h-6 w-full rounded skeleton mb-2"></div>
        <div class="h-6 w-3/4 rounded skeleton"></div>
      </div>
    </div>

    <p class="mt-3 text-xs text-slate-500">* Demo verze se statickými daty. V ostré verzi připojíme AI teze + zprávy + živé ceny.</p>
  </main>

  <script>
    // ===== Helpers =====
    const fmt = new Intl.NumberFormat('cs-CZ', { maximumFractionDigits: 2 });
    const pct = v => (v >= 0 ? '+' : '') + v.toFixed(2) + '%';
    const rowsEl = document.getElementById('rows');
    const loadingEl = document.getElementById('loading');

    // převod bodů do SVG path
    function pathFrom(points, width=180, height=64, pad=4){
      const max = Math.max(...points.map(v=>Math.abs(v))) || 1;
      const step = (width - pad*2) / (points.length-1);
      const scaleY = (v)=> (height/2 - (v/max)*(height/2 - pad));
      const scaleX = (i)=> pad + i*step;
      let d = '';
      points.forEach((v,i)=>{
        const x = scaleX(i), y = scaleY(v);
        d += (i===0?`M${x},${y}`:` L${x},${y}`);
      });
      return d;
    }

    // mini-graf s „dnes“ čárou a štítky napravo
    function sparkSVG(series, forecast){
      const w=220,h=72,pad=4;
      const dAvg = pathFrom(series.avg, w, h, pad);
      const dMin = pathFrom(series.min, w, h, pad);
      const dMax = pathFrom(series.max, w, h, pad);
      const step = (w - pad*2) / (series.avg.length-1);
      const guideX = pad + step*(series.avg.length-1);
      return `
        <div class="spark-wrap">
          <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" class="spark">
            <line class="guide" x1="${guideX}" y1="0" x2="${guideX}" y2="${h}"></line>
            <path class="min" d="${dMin}"></path>
            <path class="max" d="${dMax}"></path>
            <path class="avg" d="${dAvg}"></path>
          </svg>
          <div class="target-badges">
            <div class="b"><span class="dot max"></span><span>Max</span><strong>${fmt.format(forecast.max)}</strong></div>
            <div class="b"><span class="dot avg"></span><span>Avg</span><strong>${fmt.format(forecast.avg)}</strong></div>
            <div class="b"><span class="dot min"></span><span>Min</span><strong>${fmt.format(forecast.min)}</strong></div>
          </div>
        </div>`;
    }

    // ===== Demo generátor pro tickery z JSONu =====
    function rand(a,b){ return a + Math.random()*(b-a); }
    function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function demoFromUniverseItem(u){
      // základní cena podle typu, jen aby to působilo realisticky
      const basePriceByType = { stock: rand(10,400), index: rand(1000,6000), forex: rand(0.5,1.5), crypto: rand(0.02,90000), commodity: rand(20,250) };
      const price = basePriceByType[u.type] || rand(10,500);
      const d1 = rand(-3,3);
      const w1 = rand(-8,8);

      // forecast vychází z price ± rozpětí
      const spread = Math.max(0.15*price, 0.05*price + Math.abs(w1)*0.01*price);
      const avg = price * (1 + rand(-0.05, 0.20));
      const min = Math.max( avg - spread, avg*0.2 );
      const max = avg + spread;
      const conf = Math.round(rand(50,85));

      // mini-graf – avg mezi min a max, závěr blízko ‚avg‘
      const steps = 8, avgSeries=[], minSeries=[], maxSeries=[];
      let curAvg=0, curMin=0, curMax=0;
      for(let i=0;i<steps;i++){
        curAvg += rand(-0.3,0.5);
        curMin  = curAvg - rand(0.6,1.2);
        curMax  = curAvg + rand(0.6,1.2);
        avgSeries.push(curAvg);
        minSeries.push(curMin);
        maxSeries.push(curMax);
      }
      // posuň poslední bod avg tak, aby vizuálně odpovídal „mezi“ min/max
      avgSeries[steps-1] = (minSeries[steps-1] + maxSeries[steps-1]) / 2;

      // jednoduché teze podle typu
      const thesisByType = {
        stock: 'Růst služeb/produktů, stabilní marže, expanze.',
        index: 'Makro trend, earnings sezóna, riziková prémie.',
        forex: 'Úrokový diferenciál, inflace, risk-on/off flow.',
        crypto:'ETF/přítok kapitálu, narativ digitálního aktiva.',
        commodity:'Nabídka/poptávka, zásoby, geopolitika.'
      };
      const invalidByType = {
        stock: 'Breakdown pod klíčovou úroveň s objemy a slabá guidance.',
        index: 'Silný risk-off, geopolitický šok, slabé earnings.',
        forex: 'Nečekaný obrat politiky CB, intervence, recese.',
        crypto:'Regulační tlak, útok na síť, risk-off panika.',
        commodity:'Nadprůměrné zásoby, vyšší nabídka, slabá poptávka.'
      };

      return {
        type: u.type,
        symbol: u.symbol,
        name: u.name,
        price, d1, w1,
        forecast: { min, avg, max, conf },
        thesis: thesisByType[u.type] || 'Tržní teze (demo).',
        invalid: invalidByType[u.type] || 'Podmínky neplatnosti (demo).',
        path: { avg: avgSeries, min: minSeries, max: maxSeries }
      };
    }

    // ===== UI rendering =====
    function renderRow(r){
      const row = document.createElement('div');
      row.className = "row";
      row.innerHTML = `
        <div class="grid grid-cols-[110px,1fr,120px,110px,110px,230px,90px,90px] items-center px-4 py-3 border-t border-slate-100 cursor-pointer">
          <div class="font-semibold">${r.symbol}</div>
          <div class="text-slate-700">${r.name}</div>
          <div class="text-right tabular-nums">${fmt.format(r.price)}</div>
          <div class="text-right tabular-nums ${r.d1>=0?'text-emerald-600':'text-rose-600'}">${pct(r.d1)}</div>
          <div class="text-right tabular-nums ${r.w1>=0?'text-emerald-600':'text-rose-600'}">${pct(r.w1)}</div>
          <div class="text-center tabular-nums">
            ${fmt.format(r.forecast.min)} / <span class="font-semibold">${fmt.format(r.forecast.avg)}</span> / ${fmt.format(r.forecast.max)}
          </div>
          <div class="text-right tabular-nums">${r.forecast.conf}%</div>
          <div class="text-right">
            <button class="px-3 py-1.5 text-sm rounded-lg border border-slate-200 hover:bg-slate-50">Detail</button>
          </div>
        </div>
        <div class="hidden px-4 pb-4">
          <div class="grid md:grid-cols-[300px,1fr,1fr] gap-6 mt-3 rounded-xl border border-slate-100 bg-slate-50 p-4">
            <div>
              <div class="text-xs text-slate-500 mb-1">Mini-graf — 1Y (demo)</div>
              <div class="rounded-lg border border-slate-200 bg-white p-2">
                ${sparkSVG(r.path, r.forecast)}
              </div>
              <div class="mt-1 text-[11px] text-slate-500">Plná čára: <b>avg</b> · čárkovaně: <b>min/max</b> · tečkovaná: <b>dnes</b></div>
            </div>
            <div class="text-sm">
              <div class="text-slate-500 mb-1">Teze</div>
              <div class="bg-white border border-slate-200 rounded-lg p-3">${r.thesis}</div>
            </div>
            <div class="text-sm">
              <div class="text-slate-500 mb-1">Neplatí, pokud</div>
              <div class="bg-white border border-slate-200 rounded-lg p-3">${r.invalid}</div>
              <div class="mt-3 text-xs text-slate-500">*Ukázková data, demo verze.</div>
            </div>
          </div>
        </div>
      `;
      const head = row.querySelector('.grid');
      const detailBtn = row.querySelector('button');
      const panel = row.children[1];
      function toggle(){ panel.classList.toggle('hidden'); }
      head.addEventListener('click', (e)=>{ if(e.target.tagName.toLowerCase() === 'button') return; toggle(); });
      detailBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggle(); });
      rowsEl.appendChild(row);
    }

    function render(list){
      rowsEl.innerHTML = '';
      list.forEach(renderRow);
    }

    // ===== Filtry / třídění =====
    const q = document.getElementById('q');
    const typeFilter = document.getElementById('typeFilter');
    const sortBy = document.getElementById('sortBy');
    let ROWS = []; // naplní se po fetchi

    function apply(){
      const term = q.value.trim().toLowerCase();
      let out = ROWS.filter(r =>
        (!typeFilter.value || r.type === typeFilter.value) &&
        (!term || r.symbol.toLowerCase().includes(term) || r.name.toLowerCase().includes(term))
      );
      switch(sortBy.value){
        case 'price': out.sort((a,b)=> b.price - a.price); break;
        case 'w1': out.sort((a,b)=> b.w1 - a.w1); break;
        case 'conf': out.sort((a,b)=> b.forecast.conf - a.forecast.conf); break;
        default: out.sort((a,b)=> a.symbol.localeCompare(b.symbol));
      }
      render(out);
    }

    q.addEventListener('input', apply);
    typeFilter.addEventListener('change', apply);
    sortBy.addEventListener('change', apply);
    document.addEventListener('keydown', (e)=>{ if(e.key === '/') { e.preventDefault(); q.focus(); }});

    // ===== Načtení tickerů z assets/universe-lite.json =====
    async function bootstrap(){
      loadingEl.classList.remove('hidden');
      try {
        const res = await fetch('/assets/universe-lite.json', {cache:'no-store'});
        const data = await res.json();
        const uni = Array.isArray(data) ? data : (data.universe || []);

        // necháme cca 500 položek (když jich bude víc), a z každé uděláme demo řádek
        ROWS = uni.slice(0, 500).map(demoFromUniverseItem);

        apply();
      } catch (e){
        rowsEl.innerHTML = `<div class="p-6 text-sm text-rose-700 bg-rose-50 border border-rose-200 rounded-xl">
          Nepodařilo se načíst <code>assets/universe-lite.json</code>. Zkontroluj cestu / nasazení.
        </div>`;
        console.error(e);
      } finally {
        loadingEl.classList.add('hidden');
      }
    }

    bootstrap();
  </script>
</body>
</html>
