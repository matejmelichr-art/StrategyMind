<!doctype html>
<html lang="cs" dir="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StrategyMind — AI pro příležitosti, trhy, reality a money management</title>

  <!-- Performance -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="image" href="logo.png" imagesrcset="logo.png 1x">
  <meta name="color-scheme" content="light dark"/>

  <!-- OG / ikony -->
  <link rel="icon" type="image/png" href="logo.png" />
  <meta property="og:title" content="StrategyMind — AI pro příležitosti, reality a money management" />
  <meta property="og:image" content="logo.png" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand:'#0A2342', mint:'#2bd4a9', ink:'#0f172a', warn:'#FFB020' },
          boxShadow: { soft:'0 20px 60px -20px rgba(2,6,23,.12)' },
          borderRadius: { xl2:'1.25rem' }
        }
      }
    }
  </script>
  <style>
    html{ -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .glass{ backdrop-filter: blur(8px); background: rgba(255,255,255,.6); }
    .dark .glass{ background: rgba(17,24,39,.5); }
    .ticker-up{ color:#059669 }
    .ticker-down{ color:#dc2626 }
    canvas{ image-rendering: -webkit-optimize-contrast; }
  </style>
</head>
<body class="bg-gradient-to-b from-slate-50 via-white to-slate-50 text-slate-900 dark:from-slate-900 dark:via-slate-950 dark:to-slate-900 dark:text-slate-100">

  <!-- NAV -->
  <header class="sticky top-0 z-50 border-b border-slate-200/70 dark:border-slate-800/60 glass">
    <div class="mx-auto flex max-w-7xl items-center justify-between px-6 py-3">
      <a href="#" class="flex items-center gap-3">
        <!-- Fast logo: svg fallback (okamžitě), obrázek naskočí hned jak se načte -->
        <svg class="h-9 w-9 rounded-2xl overflow-hidden bg-brand/10" viewBox="0 0 64 64" aria-hidden="true">
          <circle cx="32" cy="32" r="28" fill="#0A2342"></circle>
          <path d="M18 36l8 8 20-24" stroke="#2bd4a9" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <img src="logo.png" alt="" class="h-9 w-9 rounded-2xl absolute opacity-0" onload="this.classList.remove('opacity-0')" decoding="async" fetchpriority="high" />
        <span class="ml-11 text-xl font-semibold tracking-tight">StrategyMind</span>
      </a>
      <nav class="hidden items-center gap-6 text-sm md:flex">
        <a class="hover:text-slate-700 dark:hover:text-slate-200" href="#trading">Trading</a>
        <a class="hover:text-slate-700 dark:hover:text-slate-200" href="#realestate">Reality</a>
        <a class="hover:text-slate-700 dark:hover:text-slate-200" href="#money">Money Management</a>
        <a class="hover:text-slate-700 dark:hover:text-slate-200" href="#ideas">Idea Lab</a>
      </nav>
      <div class="hidden md:flex items-center gap-3">
        <a href="#pricing" class="rounded-xl border border-slate-300/60 dark:border-slate-700 bg-white/60 dark:bg-slate-800/60 px-3 py-1.5 text-sm shadow-sm">Ceník</a>
        <a href="#trading" class="rounded-xl bg-brand px-3 py-1.5 text-white shadow-soft">Spustit</a>
      </div>
      <button id="menuBtn" class="md:hidden inline-flex h-10 w-10 items-center justify-center rounded-xl border border-slate-200 dark:border-slate-700">☰</button>
    </div>
    <div id="menuSheet" class="hidden border-t border-slate-200 dark:border-slate-800 md:hidden">
      <div class="mx-auto flex max-w-7xl flex-col gap-4 px-6 py-4 text-sm">
        <a href="#trading" onclick="closeMenu()">Trading</a>
        <a href="#realestate" onclick="closeMenu()">Reality</a>
        <a href="#money" onclick="closeMenu()">Money Management</a>
        <a href="#ideas" onclick="closeMenu()">Idea Lab</a>
        <a href="#pricing" onclick="closeMenu()">Ceník</a>
      </div>
    </div>
  </header>

  <!-- HERO compact -->
  <section class="mx-auto max-w-7xl px-6 pt-8 pb-6">
    <div class="grid md:grid-cols-2 gap-8 items-center">
      <div>
        <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight">
          <span class="block">Inteligentní dashboard</span>
          <span class="bg-gradient-to-r from-emerald-600 to-teal-400 bg-clip-text text-transparent">pro trhy, reality a peníze</span>
        </h1>
        <p class="mt-3 text-slate-600 dark:text-slate-300">
          Live tickery s predikcí, zprávy, real-estate nápady s ROI a osobní plán financí. Vše propojené s AI specialisty.
        </p>
        <div class="mt-4 flex flex-wrap gap-3">
          <a href="#trading" class="rounded-xl bg-brand px-4 py-2 text-white shadow-soft">Do Tradingu</a>
          <a href="#realestate" class="rounded-xl border border-slate-300 px-4 py-2 dark:border-slate-700">Hledat reality</a>
        </div>
      </div>
      <div class="relative">
        <div class="pointer-events-none absolute -inset-6 -z-10 rounded-[2rem] bg-gradient-to-tr from-emerald-500/20 via-teal-400/10 to-transparent blur-2xl"></div>
        <div class="relative mx-auto max-w-md rounded-[2rem] border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-6 shadow-2xl">
          <div class="text-sm text-slate-600 dark:text-slate-300">Rychlý přehled</div>
          <div class="mt-3 grid grid-cols-3 gap-3 text-center">
            <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-3">
              <div class="text-xs">AI predikce</div>
              <div class="text-xl font-bold">Intraday</div>
            </div>
            <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-3">
              <div class="text-xs">Reality</div>
              <div class="text-xl font-bold">Nápady</div>
            </div>
            <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-3">
              <div class="text-xs">Rozpočet</div>
              <div class="text-xl font-bold">50/30/20</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- DASHBOARD TABS -->
  <section class="mx-auto max-w-7xl px-6 pb-2">
    <div class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/60 p-3 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="flex gap-2 text-sm">
          <button data-tab="tab-trading" class="tab-btn rounded-lg bg-brand/10 text-brand px-3 py-1.5">Trading</button>
          <button data-tab="tab-realestate" class="tab-btn rounded-lg px-3 py-1.5">Reality</button>
          <button data-tab="tab-money" class="tab-btn rounded-lg px-3 py-1.5">Money</button>
          <button data-tab="tab-ideas" class="tab-btn rounded-lg px-3 py-1.5">Idea Lab</button>
        </div>
        <div class="text-xs text-slate-500">Refresh: <span id="lastRefresh">–</span></div>
      </div>
    </div>
  </section>

  <!-- TAB: TRADING -->
  <section id="tab-trading" class="tab-panel mx-auto max-w-7xl px-6 py-6">
    <div class="flex flex-wrap items-end gap-3">
      <div class="grow">
        <label class="text-sm">Symboly (čárkou):</label>
        <input id="symbolsInput" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 px-3 py-2 text-sm" placeholder="AAPL,NVDA,SPY,BTCUSD,XAUUSD">
      </div>
      <div>
        <label class="text-sm">Filtr:</label>
        <select id="filterSelect" class="mt-1 rounded-xl border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 px-3 py-2 text-sm">
          <option value="all">Vše</option>
          <option value="equity">Akcie</option>
          <option value="index">Indexy</option>
          <option value="crypto">Krypto</option>
          <option value="commodity">Komodity</option>
        </select>
      </div>
      <div>
        <label class="text-sm">Sparkline:</label>
        <select id="rangeSelect" class="mt-1 rounded-xl border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 px-3 py-2 text-sm">
          <option value="">Off</option>
          <option value="1y" selected>1Y</option>
        </select>
      </div>
      <button id="loadSymbols" class="rounded-xl bg-brand px-4 py-2 text-white shadow-soft">Načíst</button>
    </div>

    <!-- Live grid -->
    <div id="tickersGrid" class="mt-6 grid gap-3 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>

    <!-- Detail modal -->
    <dialog id="symbolModal" class="rounded-2xl border border-slate-200 dark:border-slate-800 p-0 w-[min(96vw,1000px)]">
      <div class="glass border-b border-slate-200 dark:border-slate-800 px-4 py-3 flex items-center justify-between">
        <div class="text-lg font-semibold"><span id="mSymbol">SYMB</span> – detail</div>
        <button onclick="closeModal()" class="px-3 py-1 rounded-lg border border-slate-300 dark:border-slate-700">Zavřít</button>
      </div>
      <div class="p-4 grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2">
          <canvas id="sparkCanvas" height="140"></canvas>
          <div class="mt-3 grid grid-cols-3 gap-3 text-sm">
            <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-3">
              <div class="text-xs text-slate-500">Intraday</div>
              <div class="font-semibold"><span id="pIntraday"></span></div>
            </div>
            <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-3">
              <div class="text-xs text-slate-500">Swing</div>
              <div class="font-semibold"><span id="pSwing"></span></div>
            </div>
            <div class="rounded-xl border border-slate-200 dark:border-slate-800 p-3">
              <div class="text-xs text-slate-500">Long</div>
              <div class="font-semibold"><span id="pLong"></span></div>
            </div>
          </div>
          <label class="mt-3 inline-flex items-center gap-2 text-sm">
            <input id="analyzePast" type="checkbox" class="h-4 w-4 rounded border-slate-300 dark:border-slate-700">
            <span>Analyze past (shrnutí korelací)</span>
          </label>
          <button id="askStockAI" class="ml-3 rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-1.5 text-sm">Zeptat se AI</button>
          <div id="stockAIOut" class="mt-3 whitespace-pre-wrap text-sm hidden"></div>
        </div>
        <div>
          <div class="text-sm font-semibold mb-2">Zprávy</div>
          <div id="newsList" class="space-y-2 max-h-[340px] overflow-auto pr-1"></div>
        </div>
      </div>
    </dialog>
  </section>

  <!-- TAB: REAL ESTATE -->
  <section id="tab-realestate" class="tab-panel hidden mx-auto max-w-7xl px-6 py-6">
    <div class="grid md:grid-cols-3 gap-4">
      <div class="md:col-span-2 rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white/70 dark:bg-slate-900/60">
        <div class="flex gap-3 items-end">
          <div class="grow">
            <label class="text-sm">Lokalita / dotaz</label>
            <input id="reQuery" class="mt-1 w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 px-3 py-2 text-sm" placeholder="Praha byt, Brno pozemek, Barcelona commercial…">
          </div>
          <div>
            <label class="text-sm">Typ</label>
            <select id="reType" class="mt-1 rounded-xl border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/60 px-3 py-2 text-sm">
              <option value="auto">Auto</option>
              <option value="apartment">Byt</option>
              <option value="house">Dům</option>
              <option value="land">Pozemek</option>
              <option value="commercial">Komerční</option>
            </select>
          </div>
          <button id="reSearch" class="rounded-xl bg-brand px-4 py-2 text-white shadow-soft">Hledat</button>
        </div>
        <div id="reList" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
      </div>
      <div class="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white/70 dark:bg-slate-900/60">
        <div class="text-sm font-semibold mb-2">AI nápady & ROI</div>
        <div class="text-xs text-slate-500 mb-2">Vyber z výsledků vlevo a stiskni „Nápady“.</div>
        <div id="reIdeas" class="text-sm whitespace-pre-wrap"></div>
      </div>
    </div>
  </section>

  <!-- TAB: MONEY -->
  <section id="tab-money" class="tab-panel hidden mx-auto max-w-7xl px-6 py-6">
    <div class="grid md:grid-cols-3 gap-4">
      <div class="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white/70 dark:bg-slate-900/60">
        <div class="text-sm font-semibold">Rozpočtový koláč</div>
        <canvas id="pieCanvas" class="mt-3" height="200"></canvas>
        <div class="mt-3 grid grid-cols-3 gap-3 text-sm">
          <div><label>Fixní</label><input id="pieFixed" type="number" value="50" class="mt-1 w-full rounded-lg border px-2 py-1"></div>
          <div><label>Volné</label><input id="pieFlex" type="number" value="30" class="mt-1 w-full rounded-lg border px-2 py-1"></div>
          <div><label>Investice</label><input id="pieInv" type="number" value="20" class="mt-1 w-full rounded-lg border px-2 py-1"></div>
        </div>
        <button id="pieApply" class="mt-3 rounded-lg border px-3 py-1.5 text-sm">Přepočítat</button>
        <div class="mt-3 text-xs text-slate-500">Tip: OSVČ často cílí na 40/30/30. Traderům se osvědčuje 60/20/20 (fix/flex/invest) + „risk budget“.</div>
      </div>

      <div class="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white/70 dark:bg-slate-900/60">
        <div class="text-sm font-semibold">Kalkulačky</div>
        <div class="mt-3 text-sm space-y-2">
          <div class="rounded-lg border p-2">
            <div class="font-semibold">Složené úročení</div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <input id="ciPrincipal" class="rounded border px-2 py-1" type="number" placeholder="Počáteční (Kč)" value="100000">
              <input id="ciMonthly" class="rounded border px-2 py-1" type="number" placeholder="Měsíční vklad (Kč)" value="3000">
              <input id="ciYears" class="rounded border px-2 py-1" type="number" placeholder="Roky" value="10">
              <input id="ciRate" class="rounded border px-2 py-1" type="number" placeholder="Roční % (např. 8)" value="8">
            </div>
            <button id="ciCalc" class="mt-2 rounded-lg border px-3 py-1.5 text-sm">Spočítat</button>
            <div id="ciOut" class="mt-2 text-xs whitespace-pre-wrap"></div>
          </div>
          <div class="rounded-lg border p-2">
            <div class="font-semibold">Dluh – sněhová koule</div>
            <div class="text-xs">Zadej dluhy „částka:úrok%“ po čárce. Např.: <i>40000:19, 120000:9</i></div>
            <input id="debtInput" class="mt-1 w-full rounded border px-2 py-1 text-sm" placeholder="dluhy…">
            <button id="debtCalc" class="mt-2 rounded-lg border px-3 py-1.5 text-sm">Plán</button>
            <div id="debtOut" class="mt-2 text-xs whitespace-pre-wrap"></div>
          </div>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white/70 dark:bg-slate-900/60">
        <div class="text-sm font-semibold">AI Money kouč</div>
        <textarea id="moneyAsk" class="mt-2 w-full rounded-lg border px-2 py-1 text-sm" rows="5" placeholder="Zeptej se na cokoliv…"></textarea>
        <button id="moneyGo" class="mt-2 rounded-lg border px-3 py-1.5 text-sm">Zeptat se</button>
        <div id="moneyOut" class="mt-2 text-sm whitespace-pre-wrap"></div>
      </div>
    </div>
  </section>

  <!-- TAB: IDEA LAB -->
  <section id="tab-ideas" class="tab-panel hidden mx-auto max-w-7xl px-6 py-6">
    <div class="grid md:grid-cols-2 gap-4">
      <div class="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white/70 dark:bg-slate-900/60">
        <div class="text-sm font-semibold">Generátor nápadů (digitální produkty, SaaS, AI, obsah…)</div>
        <textarea id="ideaAsk" class="mt-2 w-full rounded-lg border px-2 py-1 text-sm" rows="6" placeholder="Co chceš vytvořit? Na jaký trh cílíš, rozpočet, skills…"></textarea>
        <button id="ideaGo" class="mt-2 rounded-lg border px-3 py-1.5 text-sm">Navrhni plán</button>
      </div>
      <div class="rounded-2xl border border-slate-200 dark:border-slate-800 p-4 bg-white/70 dark:bg-slate-900/60">
        <div class="text-sm font-semibold">Výstup</div>
        <div id="ideaOut" class="mt-2 text-sm whitespace-pre-wrap"></div>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="mx-auto max-w-7xl px-6 py-10">
    <div class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/60 p-5 text-xs text-slate-500 shadow-sm">
      Upozornění: Informace nejsou investičním doporučením. Data mohou být zpožděná a bez záruky. © <span id="y"></span> StrategyMind
    </div>
  </footer>

  <!-- ========== JS: API klient + UI logika ========== -->
  <script>
    // ====== Worker API base (přizpůsob si pokud běží jinde) ======
    const API_BASE = ""; // prázdné = stejné origin (doporučeno). Nebo 'https://tight-field-436e.matejmelichr.workers.dev'
    const endpoint = (p) => new URL(p, API_BASE || location.origin).toString();

    // ====== UI init ======
    const menuBtn=document.getElementById('menuBtn');
    const menuSheet=document.getElementById('menuSheet');
    function closeMenu(){ menuSheet.classList.add('hidden'); }
    menuBtn?.addEventListener('click',()=> menuSheet.classList.toggle('hidden'));
    document.getElementById('y').textContent = new Date().getFullYear();

    // Tabs
    const tabs = [...document.querySelectorAll('.tab-btn')];
    const panels = [...document.querySelectorAll('.tab-panel')];
    tabs.forEach(btn=>{
      btn.addEventListener('click',()=>{
        tabs.forEach(b=>b.classList.remove('bg-brand/10','text-brand'));
        btn.classList.add('bg-brand/10','text-brand');
        const id = btn.dataset.tab;
        panels.forEach(p=>p.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
      });
    });

    // ====== Helpers ======
    function el(tag, cls, html){ const n=document.createElement(tag); if(cls) n.className=cls; if(html!==undefined) n.innerHTML=html; return n; }
    async function safeFetch(url, opts){ try{ const r=await fetch(url,opts); if(!r.ok) throw new Error(await r.text()); return r.json(); } catch(e){ console.warn('fetch failed', e); return null; } }
    const fmt = (n, d=2)=> (n==null||isNaN(n)) ? '—' : Number(n).toLocaleString('cs-CZ',{maximumFractionDigits:d});
    const trendIcon = (dp)=> dp>0 ? '▲' : dp<0 ? '▼' : '•';
    const clsTrend = (dp)=> dp>0 ? 'ticker-up' : dp<0 ? 'ticker-down' : 'text-slate-500';

    // ====== Trading ======
    const DEFAULT_SYMBOLS = "AAPL,NVDA,SPY,QQQ,MSFT,TSLA,BTCUSD,ETHUSD,EURUSD,XAUUSD,USOIL";
    const symbolsInput = document.getElementById('symbolsInput');
    const filterSelect = document.getElementById('filterSelect');
    const rangeSelect = document.getElementById('rangeSelect');
    const tickersGrid = document.getElementById('tickersGrid');
    const lastRefresh = document.getElementById('lastRefresh');
    const loadBtn = document.getElementById('loadSymbols');

    symbolsInput.value = DEFAULT_SYMBOLS;

    function classifySymbol(s){
      if(/USD|EUR|JPY|GBP|AUD|CAD|CHF/i.test(s) && s.length===6) return 'forex';
      if(/BTC|ETH|USDT|DOGE|ADA|XRP/i.test(s)) return 'crypto';
      if(/XAU|XAG|USOIL|NG|BRENT/i.test(s)) return 'commodity';
      if(/SPY|QQQ|DAX|CAC|FTSE|HSI|NIKKEI|^ES$|^NQ$/i.test(s)) return 'index';
      return 'equity';
    }

    async function loadQuotes(){
      const syms = symbolsInput.value.split(',').map(s=>s.trim().toUpperCase()).filter(Boolean);
      const filter = filterSelect.value;
      const range = rangeSelect.value;

      const url = endpoint(`/api/market/quotes?symbols=${encodeURIComponent(syms.join(','))}${range?`&range=${range}`:''}`);
      const data = await safeFetch(url);
      tickersGrid.innerHTML = '';

      (data||[]).forEach(row=>{
        const kind = classifySymbol(row.symbol);
        if(filter!=='all' && kind!==filter) return;
        const dp = row.changePct;
        const card = el('div','rounded-xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/60 p-3 hover:shadow-soft transition cursor-pointer');
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="text-sm font-semibold">${row.symbol} <span class="text-xs text-slate-500">(${kind})</span></div>
            <div class="text-xs ${clsTrend(dp)}">${trendIcon(dp)} ${fmt(dp,2)}%</div>
          </div>
          <div class="mt-1 text-2xl font-bold">${fmt(row.price)}</div>
          <div class="text-xs text-slate-500">Změna: ${fmt(row.change)} • ${row.time ? new Date(row.time).toLocaleTimeString():''}</div>
          ${row.history?'<canvas class="mt-2 h-[50px] w-full" data-history></canvas>':''}
          <div class="mt-2 grid grid-cols-3 gap-2 text-xs">
            <div class="rounded border border-slate-200 dark:border-slate-800 p-2" data-pred="intraday">Intraday…</div>
            <div class="rounded border border-slate-200 dark:border-slate-800 p-2" data-pred="swing">Swing…</div>
            <div class="rounded border border-slate-200 dark:border-slate-800 p-2" data-pred="long">Long…</div>
          </div>
        `;
        card.addEventListener('click',()=>openSymbol(row));
        tickersGrid.appendChild(card);

        if(row.history){
          drawSpark(card.querySelector('[data-history]'), row.history);
        }
        // predikce
        fetch(endpoint(`/api/market/predict?symbol=${row.symbol}`)).then(r=>r.json()).then(p=>{
          ['intraday','swing','long'].forEach(k=>{
            const b=card.querySelector(`[data-pred="${k}"]`);
            if(b && p?.[k]){
              b.innerHTML = `<div class="font-semibold">${Math.round(p[k].prob_up*100)}% ↑</div><div class="text-slate-500">Cíl: ${fmt(p[k].target_up)}</div>`;
            }
          });
        }).catch(()=>{});
      });

      lastRefresh.textContent = new Date().toLocaleTimeString();
    }

    function drawSpark(canvas, points){
      if(!canvas||!points?.length) return;
      const ctx = canvas.getContext('2d');
      const w = canvas.clientWidth, h = canvas.clientHeight;
      canvas.width = w*2; canvas.height = h*2; ctx.scale(2,2);
      ctx.clearRect(0,0,w,h);
      const xs = points.map(p=>p[0]); const ys = points.map(p=>p[1]);
      const x0 = Math.min(...xs), x1 = Math.max(...xs);
      const y0 = Math.min(...ys), y1 = Math.max(...ys);
      const fx = v=> (w-2)*(v - x0)/(x1-x0+1) + 1;
      const fy = v=> h - ((h-2)*(v - y0)/(y1-y0+1) + 1);
      ctx.beginPath(); ctx.lineWidth=1.5; ctx.strokeStyle='#0ea5e9';
      points.forEach((p,i)=>{ const x=fx(p[0]), y=fy(p[1]); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
      ctx.stroke();
    }

    // Detail modal
    const modal = document.getElementById('symbolModal');
    const mSymbol = document.getElementById('mSymbol');
    const sparkCanvas = document.getElementById('sparkCanvas');
    const pIntraday = document.getElementById('pIntraday');
    const pSwing = document.getElementById('pSwing');
    const pLong = document.getElementById('pLong');
    const newsList = document.getElementById('newsList');
    const analyzePast = document.getElementById('analyzePast');
    const askStockAI = document.getElementById('askStockAI');
    const stockAIOut = document.getElementById('stockAIOut');

    async function openSymbol(row){
      mSymbol.textContent = row.symbol;
      drawSpark(sparkCanvas, row.history||[]);
      newsList.innerHTML = '<div class="text-xs text-slate-500">Načítám zprávy…</div>';
      stockAIOut.classList.add('hidden'); stockAIOut.textContent='';
      modal.showModal();

      // pred
      const pred = await safeFetch(endpoint(`/api/market/predict?symbol=${row.symbol}`))||{};
      const fmtPred = (x)=> x ? `${Math.round(x.prob_up*100)}% ↑  • Cíl: ${fmt(x.target_up)}` : '—';
      pIntraday.textContent = fmtPred(pred.intraday);
      pSwing.textContent = fmtPred(pred.swing);
      pLong.textContent = fmtPred(pred.long);

      // news
      const nw = await safeFetch(endpoint(`/api/news?symbol=${row.symbol}&limit=12`))||[];
      newsList.innerHTML = '';
      nw.forEach(n=>{
        const a = el('a','block rounded-lg border border-slate-200 dark:border-slate-800 p-2 hover:bg-slate-50 dark:hover:bg-slate-800 transition',`
          <div class="text-sm font-semibold line-clamp-2">${n.title||'(bez názvu)'}</div>
          <div class="text-xs text-slate-500">${n.source||''} • ${n.time? new Date(n.time).toLocaleString() : ''}</div>
        `);
        a.href = n.url||'#'; a.target="_blank"; a.rel="noopener";
        newsList.appendChild(a);
      });

      askStockAI.onclick = async ()=>{
        stockAIOut.classList.remove('hidden'); stockAIOut.textContent='Přemýšlím…';
        const domain = 'stocks';
        const user = `Zhodnoť symbol ${row.symbol}. ${analyzePast.checked?'Zaměř se na analyzovat minulost (korelace, období zvýšené volatility).':''}`;
        const res = await safeFetch(endpoint(`/api/ai/chat?domain=${domain}`),{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ messages:[{role:'user', content:user}] })
        });
        stockAIOut.textContent = res?.message?.content || '(bez odpovědi)';
      };
    }
    function closeModal(){ modal.close(); }

    // Autorefresh (60s)
    loadBtn.addEventListener('click', loadQuotes);
    loadQuotes();
    setInterval(loadQuotes, 60_000);

    // ====== Real Estate ======
    const reQuery = document.getElementById('reQuery');
    const reType = document.getElementById('reType');
    const reSearchBtn = document.getElementById('reSearch');
    const reList = document.getElementById('reList');
    const reIdeas = document.getElementById('reIdeas');

    reSearchBtn.addEventListener('click', async ()=>{
      reList.innerHTML = '<div class="text-sm text-slate-500">Hledám…</div>';
      const q = reQuery.value.trim();
      const t = reType.value;
      const data = await safeFetch(endpoint(`/api/realestate/search?query=${encodeURIComponent(q)}&type=${encodeURIComponent(t)}`))||[];
      reList.innerHTML = '';
      data.forEach(r=>{
        const card = el('div','rounded-xl border border-slate-200 dark:border-slate-800 bg-white/70 dark:bg-slate-900/60 p-3');
        card.innerHTML = `
          <div class="text-sm font-semibold">${r.title||'(bez názvu)'}</div>
          <div class="text-xs text-slate-500">${r.assetType||''}</div>
          <div class="text-xs mt-1">${r.address||''}</div>
          <div class="mt-2 flex gap-2">
            <a class="rounded-lg border px-2 py-1 text-xs" target="_blank" rel="noopener" href="${r.url}">Mapa</a>
            <button class="rounded-lg border px-2 py-1 text-xs" data-ideas>Nápady & ROI</button>
          </div>
        `;
        card.querySelector('[data-ideas]').addEventListener('click', async ()=>{
          reIdeas.textContent='Přemýšlím…';
          const prompt = `Navrhni 3–5 reálných monetizačních nápadů pro aktivum (typ: ${r.assetType}) v lokaci ${r.address}. U každého uveď orientační CAPEX/OPEX, návrh pricingu a hrubý ROI (%/rok). Přidej rizika a první kroky due diligence.`;
          const res = await safeFetch(endpoint('/api/ai/chat?domain=realestate'), {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ messages:[{role:'user', content: prompt}] })
          });
          reIdeas.textContent = res?.message?.content || '(bez odpovědi)';
        });
        reList.appendChild(card);
      });
      if(!data.length) reList.innerHTML='<div class="text-sm text-slate-500">Nic nenalezeno.</div>';
    });

    // ====== Money – donut + kalkulačky ======
    const pieCanvas = document.getElementById('pieCanvas');
    const pieFixed=document.getElementById('pieFixed'), pieFlex=document.getElementById('pieFlex'), pieInv=document.getElementById('pieInv');
    const pieApply=document.getElementById('pieApply');

    function drawPie(){
      const ctx = pieCanvas.getContext('2d'); const w=pieCanvas.clientWidth, h=pieCanvas.clientHeight;
      pieCanvas.width=w*2; pieCanvas.height=h*2; ctx.scale(2,2); ctx.clearRect(0,0,w,h);
      const parts=[+pieFixed.value||0,+pieFlex.value||0,+pieInv.value||0];
      const sum = parts.reduce((a,b)=>a+b,0)||1; const colors=['#0ea5e9','#22c55e','#f59e0b'];
      let start=-Math.PI/2;
      parts.forEach((v,i)=>{ const ang = 2*Math.PI*(v/sum); ctx.beginPath(); ctx.moveTo(w/2,h/2); ctx.fillStyle=colors[i]; ctx.arc(w/2,h/2,Math.min(w,h)/2.4,start,start+ang); ctx.closePath(); ctx.fill(); start+=ang; });
      // legenda
      const names=['Fixní','Volné','Investice'];
      names.forEach((n,i)=>{ ctx.fillStyle=colors[i]; ctx.fillRect(10,10+i*18,10,10); ctx.fillStyle='#64748b'; ctx.fillText(`${n} ${parts[i]}%`,26,19+i*18); });
    }
    drawPie();
    pieApply.addEventListener('click', drawPie);

    // Složené úročení
    document.getElementById('ciCalc').addEventListener('click',()=>{
      const P=+ciPrincipal.value||0, m=+ciMonthly.value||0, y=+ciYears.value||0, r=(+ciRate.value||0)/100;
      const n=y*12; const i=r/12; let fv=P*Math.pow(1+i,n);
      for(let k=1;k<=n;k++) fv += m*Math.pow(1+i,n-k);
      ciOut.textContent = `Za ${y} let: ${fmt(fv,0)} Kč (vklady: ${fmt(P + m*n,0)} Kč)`;
    });

    // Dluhy – sněhová koule
    document.getElementById('debtCalc').addEventListener('click',()=>{
      const raw = debtInput.value;
      const items = raw.split(',').map(s=>s.trim()).filter(Boolean).map(x=>{
        const [a,b]=x.split(':').map(z=>z.trim()); return {amt:+a||0, rate:(+b||0)/100};
      }).sort((a,b)=> (a.rate-b.rate) || (a.amt-b.amt));
      if(!items.length){ debtOut.textContent='Zadej alespoň 1 dluh ve tvaru castka:urok%'; return; }
      let txt='Pořadí splacení (od nejdražšího):\n';
      items.reverse().forEach((d,i)=> txt+=`${i+1}) ${fmt(d.amt,0)} Kč @ ${(d.rate*100).toFixed(1)}%\n`);
      debtOut.textContent=txt;
    });

    // Money AI
    const moneyGo=document.getElementById('moneyGo'), moneyAsk=document.getElementById('moneyAsk'), moneyOut=document.getElementById('moneyOut');
    moneyGo.addEventListener('click', async ()=>{
      moneyOut.textContent='Přemýšlím…';
      const res = await safeFetch(endpoint('/api/ai/chat?domain=money'),{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ messages:[{role:'user', content: moneyAsk.value||'Poradíš mi s rozpočtem?'}] })
      });
      moneyOut.textContent = res?.message?.content || '(bez odpovědi)';
    });

    // ====== Idea Lab (AI) ======
    const ideaGo = document.getElementById('ideaGo'), ideaAsk=document.getElementById('ideaAsk'), ideaOut=document.getElementById('ideaOut');
    ideaGo.addEventListener('click', async ()=>{
      ideaOut.textContent='Přemýšlím…';
      const res = await safeFetch(endpoint('/api/ai/chat?domain=ideas'), {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ messages:[{role:'user', content: ideaAsk.value||'Chci vytvořit malý SaaS pro SMB…'}] })
      });
      ideaOut.textContent = res?.message?.content || '(bez odpovědi)';
    });

  </script>
</body>
</html>
